<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>BLANCO Offline Order App</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="apple-mobile-web-app-title" content="BLANCO Orders" />
    <link rel="apple-touch-icon" href="/icons/icon-192.png" />

    <style>
      :root {
        --bg: #000000;
        --panel: #0b0b0b;
        --panel-strong: #111111;
        --border: #1f1f1f;
        --border-strong: #2a2a2a;
        --accent: #ffffff;
        --accent-strong: #d4d4d4;
        --text: #ffffff;
        --muted: #b0b0b0;
        --shadow: 0 25px 70px rgba(0, 0, 0, 0.65);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont,
          sans-serif;
        background: var(--bg);
        color: var(--text);
        padding: 18px;
        min-height: 100vh;
        display: flex;
        justify-content: center;
      }

      .app {
        width: 100%;
        max-width: 1180px;
        background: var(--panel);
        border-radius: 18px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
        padding: 16px 18px 18px;
        backdrop-filter: blur(12px);
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid var(--border);
        padding-bottom: 12px;
        margin-bottom: 12px;
      }

      header h1 {
        margin: 0;
        font-size: 20px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }

      header span {
        font-size: 12px;
        color: var(--muted);
      }

      .subtext {
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 8px;
      }

      /* NAV */
      .nav {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 12px;
      }

      .nav button {
        border-radius: 999px;
        padding: 7px 14px;
        border: 1px solid var(--border-strong);
        background: var(--panel-strong);
        color: var(--text);
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        cursor: pointer;
        transition: transform 0.12s ease, box-shadow 0.12s ease,
          border-color 0.12s ease;
      }

      .nav button:hover {
        transform: translateY(-1px);
        border-color: var(--accent);
      }

      .nav button.active {
        background: #151515;
        border-color: var(--accent);
        color: var(--text);
        box-shadow: 0 12px 24px rgba(255, 255, 255, 0.08);
      }

      .view {
        display: none;
      }

      .view.active {
        display: block;
      }

      /* CARDS / HEADINGS */
      section.card {
        background: var(--panel-strong);
        border-radius: 14px;
        border: 1px solid var(--border);
        padding: 12px;
        margin-bottom: 12px;
        color: var(--text);
        box-shadow: 0 16px 32px rgba(0, 0, 0, 0.45);
      }

      h2 {
        margin: 0 0 6px;
        font-size: 16px;
        color: #f8fafc;
        letter-spacing: 0.02em;
      }

      /* DASHBOARD STATS */
      .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 10px;
      }

      .stat-card {
        background: var(--panel);
        border-radius: 12px;
        border: 1px solid var(--border);
        padding: 10px;
        color: var(--text);
      }

      .stat-label {
        font-size: 11px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        margin-bottom: 2px;
      }

      .stat-value {
        font-size: 19px;
        font-weight: 700;
        color: #f8fafc;
      }

      /* FORMS */
      label {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted);
        display: block;
        margin-bottom: 3px;
      }

      input,
      textarea,
      select {
        width: 100%;
        padding: 8px 10px;
        border-radius: 9px;
        border: 1px solid var(--border);
        font-size: 13px;
        background: var(--panel);
        color: var(--text);
        transition: border-color 0.12s ease, box-shadow 0.12s ease;
      }

      input::placeholder,
      textarea::placeholder {
        color: #6b7280;
      }

      input:focus,
      textarea:focus,
      select:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(109, 226, 255, 0.15);
      }

      textarea {
        resize: vertical;
        min-height: 70px;
      }

      .field-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 10px;
        margin-bottom: 10px;
      }

      .field-full {
        margin-bottom: 10px;
      }

      /* BUTTONS */
      button {
        border-radius: 999px;
        padding: 7px 12px;
        border: 1px solid var(--border-strong);
        background: #161616;
        color: var(--text);
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        cursor: pointer;
        transition: transform 0.12s ease, box-shadow 0.12s ease,
          filter 0.12s ease;
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.4);
      }

      button:hover {
        transform: translateY(-1px);
        filter: brightness(1.05);
      }

      button.secondary {
        background: var(--panel-strong);
        color: var(--text);
        border-color: var(--border-strong);
        box-shadow: none;
      }

      button.danger {
        background: #8b1111;
        border-color: #b91c1c;
        color: #fff;
        box-shadow: 0 10px 20px rgba(139, 17, 17, 0.24);
      }

      button.selected,
      button.active {
        background: #1f1f1f !important;
        color: var(--text) !important;
        border-color: var(--accent) !important;
      }

      button.small {
        font-size: 11px;
        padding: 5px 10px;
      }

      .actions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: flex-end;
        margin-top: 8px;
      }

      /* ORDER FLOW – STEPPER */
      .stepper {
        display: flex;
        gap: 6px;
        align-items: center;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        margin-bottom: 8px;
        color: var(--muted);
      }

      .step-pill {
        padding: 5px 12px;
        border-radius: 999px;
        border: 1px solid var(--border-strong);
        background: var(--panel);
        color: var(--text);
      }

      .step-pill.active {
        background: #1a1a1a;
        border-color: var(--accent);
        color: var(--text);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.35);
      }

      /* ORDER FLOW – STYLES GRID (step 1) */
      .styles-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 12px;
      }

      .style-card {
        background: var(--panel);
        border-radius: 12px;
        border: 1px solid var(--border);
        padding: 8px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        cursor: pointer;
        transition: 0.15s ease;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.25);
      }

      .style-card:hover {
        border-color: var(--accent);
        transform: translateY(-1px);
      }

      .style-card.selected {
        border-color: var(--accent);
        box-shadow: 0 0 0 2px rgba(109, 226, 255, 0.35);
      }

      .style-thumb {
        width: 100%;
        padding-bottom: 100%;
        background: var(--panel-strong);
        border: 1px solid var(--border);
        border-radius: 10px;
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--muted);
        font-size: 11px;
      }

      .style-thumb img {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .style-name {
        font-size: 11px;
        font-weight: 700;
        color: #f8fafc;
        text-align: center;
      }

      .style-code {
        font-size: 10px;
        color: var(--muted);
        text-align: center;
      }

      .style-meta {
        font-size: 10px;
        color: var(--muted);
        text-align: center;
      }

      /* STEP 2 – COLORS */
      .color-card {
        border-radius: 12px;
        border: 1px solid var(--border);
        margin-bottom: 10px;
        background: var(--panel);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.28);
      }

      .color-header {
        padding: 10px;
        border-bottom: 1px solid var(--border);
      }

      .color-body {
        padding: 10px;
      }

      .color-body label {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted);
        display: block;
        margin-bottom: 5px;
      }

      .color-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 8px;
      }

      @media (max-width: 600px) {
        .color-list {
          grid-template-columns: minmax(0, 1fr);
        }
      }

      .color-chip {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        border-radius: 999px;
        border: 1px solid var(--border-strong);
        padding: 8px 12px;
        background: var(--panel);
        cursor: pointer;
        font-size: 12px;
        color: var(--text);
        transition: 0.12s ease;
      }

      .color-chip:hover {
        border-color: var(--accent);
      }

      .color-chip.selected {
        background: #1a1a1a;
        border-color: var(--accent);
        color: var(--text);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.32);
      }

      /* STEP 3 – QTY */
      .qty-card {
        border-radius: 12px;
        border: 1px solid var(--border);
        margin-bottom: 10px;
        background: var(--panel);
        padding: 10px;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.28);
      }

      .qty-header {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        margin-bottom: 8px;
        color: var(--text);
      }

      .sizes-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
        gap: 8px;
      }

      .size-chip {
        background: var(--panel-strong);
        border-radius: 10px;
        border: 1px solid var(--border);
        padding: 6px 8px;
        font-size: 11px;
        color: var(--text);
      }

      .size-chip label {
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted);
        margin-bottom: 3px;
        display: block;
      }

      .size-chip input[type="number"] {
        width: 100%;
        padding: 6px 8px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: var(--panel);
        color: var(--text);
        font-size: 11px;
      }

      .size-chip input[type="number"]:focus {
        outline: none;
        border-color: var(--accent);
      }

      /* TABLES */
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 11px;
        overflow: hidden;
        border-radius: 10px;
      }

      th,
      td {
        border-bottom: 1px solid var(--border);
        padding: 7px 6px;
        text-align: left;
        color: var(--text);
      }

      th {
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted);
        background: var(--panel);
      }

      tr:last-child td {
        border-bottom: none;
      }

      .empty {
        font-size: 12px;
        text-align: center;
        color: var(--muted);
        padding: 14px 0;
      }

      /* PRODUCTS GRID */
      .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 10px;
        margin-top: 8px;
      }

      .product-card {
        background: var(--panel);
        border-radius: 10px;
        border: 1px solid var(--border);
        padding: 10px;
        display: flex;
        flex-direction: column;
        gap: 6px;
        text-align: left;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.28);
      }

      .product-image {
        width: 100%;
        padding-bottom: 68%;
        border-radius: 12px;
        background: var(--panel-strong);
        border: 1px solid var(--border);
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        color: var(--muted);
      }

      .product-image img {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .product-name {
        font-size: 11px;
        font-weight: 700;
        color: var(--text);
      }

      .product-code,
      .product-summary {
        font-size: 10px;
        color: var(--muted);
      }

      .product-actions {
        display: flex;
        gap: 6px;
        justify-content: flex-start;
        margin-top: 4px;
      }

      .product-actions button {
        font-size: 10px;
        padding: 4px 9px;
      }

      .chip-row {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }

      .chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 8px;
        border-radius: 999px;
        background: var(--panel-strong);
        border: 1px solid var(--border);
        font-size: 11px;
        color: var(--text);
      }

      .chip-actions {
        display: inline-flex;
        gap: 4px;
        align-items: center;
      }

      .chip-actions button {
        padding: 2px 6px;
        font-size: 10px;
        letter-spacing: 0;
        text-transform: none;
        border-radius: 8px;
        box-shadow: none;
        background: var(--panel);
      }

      .chip-label {
        font-weight: 600;
      }

      /* PRODUCT FORM */
      .product-form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
        gap: 10px;
      }

      .color-row {
        display: flex;
        gap: 6px;
        align-items: center;
      }

      .color-row input[type="text"] {
        flex: 1;
      }

      .color-row button {
        padding: 7px 10px;
      }

      /* MODAL */
      .modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: flex-start;
        justify-content: center;
        padding: 20px;
        overflow-y: auto;
      }

      .modal-content {
        background: var(--panel-strong);
        padding: 16px;
        border-radius: 14px;
        border: 1px solid var(--border);
        width: 100%;
        max-width: 460px;
        box-shadow: 0 18px 36px rgba(0, 0, 0, 0.45);
        max-height: calc(100vh - 60px);
        display: flex;
        flex-direction: column;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        border-bottom: 1px solid var(--border);
        padding-bottom: 8px;
      }

      .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 12px;
      }

      .modal-body {
        flex: 1 1 auto;
        overflow-y: auto;
        padding-right: 4px;
      }

      /* ORDER DETAIL */
      .order-detail-header {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 10px;
        background: var(--panel);
        font-size: 12px;
        color: var(--text);
        margin-bottom: 8px;
      }

      .order-item-card {
        background: var(--panel);
        border-radius: 12px;
        border: 1px solid var(--border);
        padding: 10px 12px;
        margin-bottom: 10px;
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.28);
        display: flex;
        gap: 10px;
        align-items: flex-start;
      }

      .order-item-thumb {
        width: 78px;
        height: 78px;
        border-radius: 10px;
        background: var(--panel-strong);
        border: 1px solid var(--border);
        position: relative;
        overflow: hidden;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--muted);
        font-size: 11px;
      }

      .order-item-thumb img {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .order-item-body {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .order-item-header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: 6px;
      }

      .order-item-title {
        font-size: 13px;
        font-weight: 700;
      }

      .order-item-subtitle {
        font-size: 11px;
        color: var(--muted);
      }

      .order-item-price {
        font-size: 11px;
        text-align: right;
      }

      .order-tag {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: var(--panel);
        font-size: 11px;
        color: var(--text);
        margin-bottom: 6px;
      }

      .order-sizes-row {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 4px;
      }

      .order-size-chip {
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid var(--border);
        font-size: 11px;
        background: var(--panel);
        color: var(--text);
      }

      .signature-section {
        margin-top: 12px;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: var(--panel);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.28);
      }

      .signature-title {
        font-size: 13px;
        font-weight: 700;
        margin-bottom: 2px;
      }

      .signature-subtext {
        font-size: 11px;
        color: var(--muted);
        margin: 0;
      }

      .signature-box {
        position: relative;
        margin-top: 10px;
        border-radius: 12px;
        border: 1px dashed var(--border);
        background: var(--panel-strong);
        overflow: hidden;
        height: 190px;
        touch-action: none;
      }

      .signature-box canvas,
      .signature-box img {
        width: 100%;
        height: 100%;
        display: block;
        touch-action: none;
        user-select: none;
      }

      .signature-placeholder {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        color: var(--muted);
        pointer-events: none;
        background: linear-gradient(
          45deg,
          rgba(255, 255, 255, 0.02),
          rgba(255, 255, 255, 0.01)
        );
      }

      .signature-actions {
        display: flex;
        gap: 6px;
        margin-top: 10px;
        justify-content: flex-end;
      }

      /* ORDER EDITOR */
      .edit-lines {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .edit-line {
        display: flex;
        flex-direction: column;
        gap: 10px;
        padding: 10px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: var(--panel);
      }

      .edit-line-header {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
        gap: 8px;
      }

      .edit-line label {
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted);
        display: block;
        margin-bottom: 4px;
      }

      .edit-line .sizes-grid {
        margin-top: 2px;
      }

      .edit-line-label {
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted);
      }

      .edit-size-chip {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .size-chip input[type="text"] {
        width: 100%;
        padding: 6px 8px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: var(--panel);
        color: var(--text);
        font-size: 11px;
      }

      .size-chip input[type="text"]:focus {
        outline: none;
        border-color: var(--accent);
      }

      .edit-line-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .edit-size-actions {
        display: flex;
        justify-content: flex-end;
        gap: 6px;
      }
    </style>
  </head>
  <body>
    <div class="app">
      <header>
        <div>
          <h1>BLANCO Clothing</h1>
          <span id="viewLabel">Dashboard</span>
        </div>
        <span id="lastActivity">No orders yet</span>
      </header>

      <div class="nav">
        <button id="nav-dashboard" class="active">Dashboard</button>
        <button id="nav-order">+ New</button>
        <button id="nav-orders">Orders</button>
        <button id="nav-products">Products</button>
      </div>

      <!-- DASHBOARD -->
      <div id="view-dashboard" class="view active">
        <section class="card">
          <h2>Snapshot</h2>
          <p class="subtext">
            Overview of offline activity on this device only.
          </p>
          <div class="stats-row">
            <div class="stat-card">
              <div class="stat-label">Offline orders</div>
              <div id="stat-orders" class="stat-value">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Styles in catalog</div>
              <div id="stat-styles" class="stat-value">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Last activity</div>
              <div id="stat-last" class="stat-value" style="font-size:13px">
                —
              </div>
            </div>
          </div>
          <div class="actions" style="justify-content:flex-start;margin-top:8px">
            <button id="dash-new-order">+ New</button>
            <button id="dash-orders" class="secondary small">
              View orders
            </button>
            <button id="dash-products" class="secondary small">
              Manage products
            </button>
          </div>
        </section>
      </div>

      <!-- ORDER FLOW -->
      <div id="view-order" class="view">
        <section class="card">
          <div class="stepper">
            <span id="step-pill-1" class="step-pill active">1. Styles</span>
            <span>›</span>
            <span id="step-pill-2" class="step-pill">2. Colors</span>
            <span>›</span>
            <span id="step-pill-3" class="step-pill">3. Sizes & Qty</span>
          </div>

          <!-- customer -->
          <div class="field-row">
            <div>
              <label for="custName">Customer</label>
              <input id="custName" placeholder="Customer name" />
            </div>
            <div>
              <label for="custClub">Country club</label>
              <input id="custClub" placeholder="Club name" />
            </div>
            <div>
              <label for="custEmail">Email</label>
              <input id="custEmail" type="email" placeholder="email@club.com" />
            </div>
            <div>
              <label for="custPhone">Phone</label>
              <input id="custPhone" placeholder="+1 (555) 123-4567" />
            </div>
          </div>

          <!-- step 1 -->
          <div id="order-step-1">
            <h2>Select Styles</h2>
            <p class="subtext">
              Tap one or more styles to include in this order. Styles are loaded
              from the Products catalog.
            </p>
            <div class="field-full">
              <label for="styleSearch">Search styles</label>
              <input
                id="styleSearch"
                placeholder="Search by style code or name"
              />
            </div>
            <div id="stylesGrid" class="styles-grid"></div>
            <div id="stylesEmpty" class="subtext">
              No styles yet – add products first.
            </div>
            <div class="actions">
              <button id="step1-next" class="secondary">
                Continue to colors ›
              </button>
            </div>
          </div>

          <!-- step 2 -->
          <div id="order-step-2" style="display:none">
            <h2>Choose Colors</h2>
            <p class="subtext">
              For each selected style, pick one or more colors.
            </p>
            <div id="colorsContainer"></div>
            <div class="actions" style="justify-content:space-between">
              <button id="step2-back" class="secondary">
                ‹ Back to styles
              </button>
              <button id="step2-next">Continue to sizes & qty ›</button>
            </div>
          </div>

          <!-- step 3 -->
          <div id="order-step-3" style="display:none">
            <h2>Sizes & Quantities</h2>
            <p class="subtext">
              Enter quantities for each style, color and size. Leave at 0 for
              sizes you don’t need.
            </p>
            <div id="qtyContainer"></div>
            <div class="field-full">
              <label for="orderNotes">Order notes</label>
              <textarea
                id="orderNotes"
                placeholder="Ship window, fit notes, event, etc."
              ></textarea>
            </div>
            <div class="actions" style="justify-content:space-between">
              <button id="step3-back" class="secondary">
                ‹ Back to colors
              </button>
              <div style="display:flex;gap:6px">
                <button id="clearOrder" class="secondary small">Clear</button>
                <button id="saveOrder">Save order</button>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- ORDERS -->
      <div id="view-orders" class="view">
        <section class="card">
          <h2>Orders</h2>
          <p class="subtext">
            Orders are stored locally on this device. Export or email per order.
          </p>
          <div class="actions" style="justify-content:flex-start">
            <button id="exportOrders" class="secondary small">
              Export all CSV
            </button>
          </div>
          <div id="ordersEmpty" class="empty">
            No orders yet – create one from the + New tab.
          </div>
          <table id="ordersTable" style="display:none;margin-top:6px">
            <thead>
              <tr>
                <th>Time</th>
                <th>Customer</th>
                <th>Styles</th>
                <th>Colors</th>
                <th>Sizes</th>
                <th>Qty</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="ordersBody"></tbody>
          </table>

          <!-- Order detail panel -->
          <div id="orderDetailPanel" style="display:none">
            <h3 style="margin:10px 0 4px;font-size:14px;">Order items</h3>
            <div id="orderDetailMeta" class="order-detail-header"></div>
            <div id="orderDetailItems"></div>
            <div id="orderSignatureSection" class="signature-section" style="display:none">
              <div>
                <div class="signature-title">Buyer signature</div>
                <p id="signatureStatus" class="signature-subtext">
                  Have the buyer sign to confirm the order.
                </p>
              </div>
              <div id="signatureBox" class="signature-box">
                <canvas id="signatureCanvas"></canvas>
                <div id="signaturePlaceholder" class="signature-placeholder">
                  Sign inside the box
                </div>
                <img
                  id="signatureImage"
                  alt="Saved signature preview"
                  style="display:none"
                />
              </div>
              <div class="signature-actions">
                <button id="signatureClearBtn" class="secondary small">
                  Clear
                </button>
                <button id="signatureEditBtn" class="secondary small">
                  Edit
                </button>
                <button id="signatureSaveBtn" class="small">Save</button>
              </div>
            </div>
          </div>

          <!-- Email template options -->
          <div style="margin-top:12px;border-top:1px solid var(--border);padding-top:8px;">
            <h3 style="margin:0 0 4px;font-size:14px;">Email template options</h3>
            <p class="subtext" style="margin-bottom:4px;">
              Customize the outgoing order email.
            </p>
            <div class="field-row">
              <button
                id="emailToggleTotalQty"
                type="button"
                class="secondary small"
                style="width:100%;"
                data-active="1"
              >
                Total quantity of items
              </button>
              <button
                id="emailToggleTotals"
                type="button"
                class="secondary small"
                style="width:100%;"
                data-active="1"
              >
                Total cost summary
              </button>
            </div>
            <div class="field-row" style="margin-top:6px;align-items:flex-end;">
              <div>
                <label for="emailUseTaxAmount" style="margin-bottom:4px;">Tax</label>
                <div style="display:flex;gap:6px;align-items:center;">
                  <button
                    id="emailUseTaxAmount"
                    type="button"
                    class="secondary small"
                    data-active="0"
                    style="white-space:nowrap;"
                  >
                    Include tax
                  </button>
                  <input
                    id="emailTaxAmount"
                    type="number"
                    step="0.01"
                    placeholder="0.00"
                    style="font-size:12px;"
                  />
                </div>
                <p class="subtext" style="margin:2px 0 0;">
                  Added to totals when enabled.
                </p>
              </div>
              <div>
                <label for="emailUseShippingAmount" style="margin-bottom:4px;">Shipping</label>
                <div style="display:flex;gap:6px;align-items:center;">
                  <button
                    id="emailUseShippingAmount"
                    type="button"
                    class="secondary small"
                    data-active="0"
                    style="white-space:nowrap;"
                  >
                    Include shipping
                  </button>
                  <input
                    id="emailShippingAmount"
                    type="number"
                    step="0.01"
                    placeholder="0.00"
                    style="font-size:12px;"
                  />
                </div>
                <p class="subtext" style="margin:2px 0 0;">
                  Added to totals when enabled.
                </p>
              </div>
            </div>
            <div class="field-row" style="margin-top:6px;">
              <div style="display:flex;align-items:center;gap:6px;">
                <input
                  id="emailIncludeNotes"
                  type="checkbox"
                  style="width:auto;margin:0;"
                />
                <span style="font-size:12px;">Include order notes</span>
              </div>
              <div style="display:flex;align-items:center;gap:6px;">
                <input
                  id="emailIncludeUnitPrice"
                  type="checkbox"
                  style="width:auto;margin:0;"
                />
                <span style="font-size:12px;">Show unit price on items</span>
              </div>
            </div>
            <div class="field-full" style="margin-top:6px;">
              <label for="emailSubjectPrefix">Subject prefix</label>
              <input
                id="emailSubjectPrefix"
                placeholder="BLANCO order"
                style="font-size:12px;"
              />
              <p class="subtext" style="margin:2px 0 0;">
                Appears before customer name and date in the subject line.
              </p>
            </div>
            <div class="field-full" style="margin-top:6px;">
              <label for="emailHeadingLine">Email heading</label>
              <input
                id="emailHeadingLine"
                placeholder="BLANCO Clothing – Order"
                style="font-size:12px;"
              />
            </div>
            <div class="field-full" style="margin-top:6px;">
              <label for="emailIntroMessage">Intro message (optional)</label>
              <textarea
                id="emailIntroMessage"
                placeholder="Thank you for your order. Please see details below."
                style="font-size:12px;"
              ></textarea>
            </div>
            <div class="field-full" style="margin-top:6px;">
              <label for="emailFooterLine">Footer line</label>
              <input
                id="emailFooterLine"
                placeholder="Generated from BLANCO offline order app."
                style="font-size:12px;"
              />
            </div>
          </div>

        </section>
      </div>

      <!-- ORDER EDIT MODAL -->
      <div id="orderEditModal" class="modal" style="display:none">
        <div class="modal-content">
          <div class="modal-header">
            <h3 style="margin:0;font-size:14px">Edit order</h3>
            <button id="orderEditClose" class="secondary small">✕</button>
          </div>

          <div class="modal-body">
            <div class="field-row">
              <div>
                <label for="orderEditName">Customer</label>
                <input id="orderEditName" placeholder="Customer name" />
              </div>
              <div>
                <label for="orderEditClub">Country club</label>
                <input id="orderEditClub" placeholder="Club name" />
              </div>
              <div>
                <label for="orderEditEmail">Email</label>
                <input
                  id="orderEditEmail"
                  type="email"
                  placeholder="email@club.com"
                />
              </div>
              <div>
                <label for="orderEditPhone">Phone</label>
                <input id="orderEditPhone" placeholder="+1 (555) 123-4567" />
              </div>
            </div>

            <div class="field-full">
              <label for="orderEditNotes">Order notes</label>
              <textarea
                id="orderEditNotes"
                placeholder="Ship window, fit notes, event, etc."
              ></textarea>
            </div>

            <h4 style="margin:6px 0;font-size:13px;">Products</h4>
            <div id="orderEditLines" class="edit-lines"></div>
            <div class="actions" style="justify-content:flex-start">
              <button id="orderEditAddLine" class="secondary small">
                + Add line
              </button>
            </div>
          </div>

          <div class="modal-footer">
            <button id="orderEditCancel" class="secondary small">
              Cancel
            </button>
            <button id="orderEditSave" class="small">Save changes</button>
          </div>
        </div>
      </div>

      <!-- PRODUCTS -->
      <div id="view-products" class="view">
        <section class="card">
          <div
            style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:6px;"
          >
            <div>
              <h2>Products</h2>
              <p class="subtext">
                Manage styles used in the + New flow. Data is stored offline on
                this device.
              </p>
            </div>
            <button id="addStyleBtn" class="small">+ Add style</button>
          </div>

          <div id="productsEmpty" class="empty">
            No styles yet – tap “+ Add style” or import a catalog CSV from
            another device.
          </div>

          <div id="productsGrid" class="products-grid"></div>

          <div class="actions" style="justify-content:flex-start;margin-top:8px;">
            <input id="catalogFile" type="file" accept=".csv" />
            <button id="importCatalog" class="secondary small">
              Import CSV
            </button>
            <button id="exportCatalog" class="secondary small">
              Export CSV
            </button>
          </div>
        </section>

        <!-- Slide-up modal editor -->
        <div id="styleModal" class="modal-backdrop" style="display:none;">
          <div class="modal-sheet">
            <div class="modal-header">
              <div id="modalTitle" class="modal-title">New style</div>
              <button
                type="button"
                id="modalCloseBtn"
                class="secondary small"
                style="border-radius:999px;width:26px;height:26px;padding:0;"
              >
                ✕
              </button>
            </div>

            <div class="modal-body">
              <div class="field-row">
                <div>
                  <label for="modalStyleName">Style name</label>
                  <input id="modalStyleName" placeholder="polo" />
                </div>
                <div>
                  <label for="modalStyleCode">Style code</label>
                  <input id="modalStyleCode" placeholder="1416-sup" />
                </div>
              </div>

              <div class="field-full">
                <label for="modalDescription">Description</label>
                <textarea
                  id="modalDescription"
                  placeholder="Enter description (optional)"
                ></textarea>
              </div>

              <div class="field-row">
                <div>
                  <label for="modalPrice">Price (per piece)</label>
                  <input id="modalPrice" type="number" min="0" step="0.01" />
                </div>
                <div>
                  <label for="modalCategory">Category</label>
                  <input
                    id="modalCategory"
                    placeholder="polo, hoodie, outerwear…"
                  />
                </div>
              </div>

              <!-- colors -->
              <div class="field-full">
                <label>Available colors</label>
                <div
                  style="display:flex;gap:6px;align-items:center;margin-bottom:4px;"
                >
                  <input
                    id="modalColorInput"
                    placeholder="Add color (enter, then +)"
                  />
                  <button id="addColorBtn" class="secondary small">+</button>
                </div>
                <div id="modalColorsRow" class="chip-row"></div>
              </div>

              <!-- sizes -->
              <div class="field-full">
                <label>Available sizes</label>
                <div
                  style="display:flex;gap:6px;align-items:center;margin-bottom:4px;"
                >
                  <input
                    id="modalSizeInput"
                    placeholder="Add size (S, M, L, XL, 32, 34…)"
                  />
                  <button id="addSizeBtn" class="secondary small">+</button>
                </div>
                <div id="modalSizesRow" class="chip-row"></div>
              </div>

              <!-- image -->
              <div class="field-full">
                <label>Product image</label>
                <div class="image-row">
                  <div id="modalImagePreview" class="image-preview">
                    <span>Tap to upload</span>
                  </div>
                  <div style="display:flex;flex-direction:column;gap:4px;">
                    <input
                      id="modalImageFile"
                      type="file"
                      accept="image/*"
                      style="font-size:11px;"
                    />
                    <small class="subtext">
                      Images are stored locally on this device (not in CSV).
                    </small>
                  </div>
                </div>
              </div>

              <div
                class="field-full"
                style="display:flex;align-items:center;gap:6px;margin-top:4px;"
              >
                <input
                  id="modalInStock"
                  type="checkbox"
                  style="width:auto;margin:0;"
                />
                <span style="font-size:12px;">In stock</span>
              </div>
            </div>

            <div class="modal-footer">
              <button id="modalCancelBtn" class="secondary small">
                Cancel
              </button>
              <button id="modalSaveBtn" class="small">Save style</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // SIMPLE, OLDER-SAFARI-FRIENDLY JS (no arrow functions)

      var ORDERS_KEY = "blanco_orders_v1";
      var CATALOG_KEY = "blanco_catalog_v1";
      var STYLE_META_KEY = "blanco_style_meta_v1";
      var EMAIL_OPTS_KEY = "blanco_email_opts_v1";
      var ORDER_SIGNATURES_KEY = "blanco_order_signatures_v1";

      var catalog = [];
      var styleMeta = {}; // styleKey -> {desc, category, imageDataUrl, in_stock}
      var selectedStyles = []; // array of styleKeys
      var selectedColors = {}; // styleKey -> { color: true }
      var currentStep = 1;
      var emailOpts = {
        includeTotalQty: true,
        includeTotalsSummary: true,
        includeTaxAmount: false,
        taxAmount: 0,
        includeShippingAmount: false,
        shippingAmount: 0,
        includeNotes: true,
        includeUnitPrice: false,
        subjectPrefix: "BLANCO order",
        headingLine: "BLANCO Clothing – Order",
        introMessage: "",
        footerLine: "Generated from BLANCO offline order app.",
      };

      var signatureMode = "view";
      var signatureCurrentTs = null;
      var signatureHasDrawing = false;
      var signatureDrawing = false;
      var signatureCtx = null;
      var signatureTouchBlockersAttached = false;
      var signatureScrollBlockerAttached = false;
      function $(id) {
        return document.getElementById(id);
      }

      // ---------- STORAGE ----------
      function getOrders() {
        try {
          var raw = localStorage.getItem(ORDERS_KEY);
          return raw ? JSON.parse(raw) : [];
        } catch (e) {
          console.log("getOrders error", e);
          return [];
        }
      }

      function saveOrdersList(list) {
        try {
          localStorage.setItem(ORDERS_KEY, JSON.stringify(list));
        } catch (e) {
          console.log("saveOrders error", e);
        }
        updateDashboard();
      }

      function getOrderSignatures() {
        try {
          var raw = localStorage.getItem(ORDER_SIGNATURES_KEY);
          return raw ? JSON.parse(raw) : {};
        } catch (e) {
          console.log("getOrderSignatures error", e);
          return {};
        }
      }

      function saveOrderSignatures(map) {
        try {
          localStorage.setItem(ORDER_SIGNATURES_KEY, JSON.stringify(map));
        } catch (e) {
          console.log("saveOrderSignatures error", e);
        }
      }

      function getCatalog() {
        try {
          var raw = localStorage.getItem(CATALOG_KEY);
          return raw ? JSON.parse(raw) : [];
        } catch (e) {
          console.log("getCatalog error", e);
          return [];
        }
      }

      function saveCatalog(list) {
        try {
          localStorage.setItem(CATALOG_KEY, JSON.stringify(list));
        } catch (e) {
          console.log("saveCatalog error", e);
        }
      }

      function loadStyleMeta() {
        try {
          var raw = localStorage.getItem(STYLE_META_KEY);
          styleMeta = raw ? JSON.parse(raw) : {};
        } catch (e) {
          styleMeta = {};
        }
      }

      function saveStyleMeta() {
        try {
          localStorage.setItem(STYLE_META_KEY, JSON.stringify(styleMeta));
        } catch (e) {}
      }

      function toBoolean(val, defaultVal) {
        if (val === undefined || val === null) return defaultVal;
        if (typeof val === "string") {
          var lower = val.toLowerCase();
          if (lower === "true") return true;
          if (lower === "false") return false;
          if (lower === "1") return true;
          if (lower === "0") return false;
        }
        return !!val;
      }

      function loadEmailOpts() {
        try {
          var raw = localStorage.getItem(EMAIL_OPTS_KEY);
          if (raw) {
            var obj = JSON.parse(raw);
            emailOpts.includeTotalQty = toBoolean(
              obj.includeTotalQty,
              true
            );
            emailOpts.includeTotalsSummary = toBoolean(
              obj.includeTotalsSummary,
              true
            );
            emailOpts.includeTaxAmount = toBoolean(obj.includeTaxAmount, false);
            emailOpts.taxAmount = obj.taxAmount || 0;
            emailOpts.includeShippingAmount = toBoolean(
              obj.includeShippingAmount,
              false
            );
            emailOpts.shippingAmount = obj.shippingAmount || 0;
            emailOpts.includeNotes = toBoolean(obj.includeNotes, true);
            emailOpts.includeUnitPrice = toBoolean(obj.includeUnitPrice, false);
            emailOpts.subjectPrefix =
              obj.subjectPrefix || "BLANCO order";
            emailOpts.headingLine =
              obj.headingLine || "BLANCO Clothing – Order";
            emailOpts.introMessage = obj.introMessage || "";
            emailOpts.footerLine =
              obj.footerLine || "Generated from BLANCO offline order app.";
          }
        } catch (e) {}

        setToggleButtonState("emailToggleTotalQty", !!emailOpts.includeTotalQty);
        setToggleButtonState(
          "emailToggleTotals",
          !!emailOpts.includeTotalsSummary
        );
        setToggleButtonState(
          "emailUseTaxAmount",
          !!emailOpts.includeTaxAmount
        );
        setToggleButtonState(
          "emailUseShippingAmount",
          !!emailOpts.includeShippingAmount
        );
        if ($("emailTaxAmount")) {
          $("emailTaxAmount").value = emailOpts.taxAmount || 0;
        }
        if ($("emailShippingAmount")) {
          $("emailShippingAmount").value = emailOpts.shippingAmount || 0;
        }

        if ($("emailIncludeNotes")) {
          $("emailIncludeNotes").checked = !!emailOpts.includeNotes;
        }
        if ($("emailIncludeUnitPrice")) {
          $("emailIncludeUnitPrice").checked =
            !!emailOpts.includeUnitPrice;
        }
        if ($("emailSubjectPrefix")) {
          $("emailSubjectPrefix").value = emailOpts.subjectPrefix || "";
        }
        if ($("emailHeadingLine")) {
          $("emailHeadingLine").value = emailOpts.headingLine || "";
        }
        if ($("emailIntroMessage")) {
          $("emailIntroMessage").value = emailOpts.introMessage || "";
        }
        if ($("emailFooterLine")) {
          $("emailFooterLine").value = emailOpts.footerLine || "";
        }

        updateEmailAmountInputsState();
      }

      function saveEmailOptsFromUI() {
        var totalsEnabled = isButtonActive("emailToggleTotals");

        emailOpts.includeTotalQty = isButtonActive("emailToggleTotalQty");
        emailOpts.includeTotalsSummary = totalsEnabled;
        emailOpts.includeTaxAmount =
          totalsEnabled && isButtonActive("emailUseTaxAmount");
        emailOpts.includeShippingAmount =
          totalsEnabled && isButtonActive("emailUseShippingAmount");
        if ($("emailTaxAmount")) {
          emailOpts.taxAmount = Number($("emailTaxAmount").value || 0);
        }
        if ($("emailShippingAmount")) {
          emailOpts.shippingAmount = Number($("emailShippingAmount").value || 0);
        }
        if ($("emailIncludeNotes")) {
          emailOpts.includeNotes = $("emailIncludeNotes").checked;
        }
        if ($("emailIncludeUnitPrice")) {
          emailOpts.includeUnitPrice =
            $("emailIncludeUnitPrice").checked;
        }
        if ($("emailSubjectPrefix")) {
          emailOpts.subjectPrefix =
            $("emailSubjectPrefix").value.trim() || "BLANCO order";
        }
        if ($("emailHeadingLine")) {
          emailOpts.headingLine =
            $("emailHeadingLine").value.trim() || "BLANCO Clothing – Order";
        }
        if ($("emailIntroMessage")) {
          emailOpts.introMessage =
            $("emailIntroMessage").value.trim();
        }
        if ($("emailFooterLine")) {
          emailOpts.footerLine =
            $("emailFooterLine").value.trim() ||
            "Generated from BLANCO offline order app.";
        }
        try {
          localStorage.setItem(
            EMAIL_OPTS_KEY,
            JSON.stringify(emailOpts)
          );
        } catch (e) {}

        updateEmailAmountInputsState();
      }

      function setToggleButtonState(id, active) {
        var el = $(id);
        if (!el) return;
        el.setAttribute("data-active", active ? "1" : "0");
        if (active) {
          if (el.className.indexOf("active") === -1)
            el.className += " active";
        } else {
          el.className = el.className.replace("active", "").trim();
        }
      }

      function isButtonActive(id) {
        var el = $(id);
        if (!el) return false;
        return el.getAttribute("data-active") === "1";
      }

      function toggleButton(id) {
        var el = $(id);
        if (!el) return;
        var next = !isButtonActive(id);
        setToggleButtonState(id, next);
      }

      function updateEmailAmountInputsState() {
        var totalsToggle = $("emailToggleTotals");
        var totalsEnabled = totalsToggle
          ? isButtonActive("emailToggleTotals")
          : true;

        var taxToggle = $("emailUseTaxAmount");
        var taxInput = $("emailTaxAmount");
        if (taxInput) {
          taxInput.disabled = taxToggle
            ? !(totalsEnabled && isButtonActive("emailUseTaxAmount"))
            : false;
        }

        var shippingToggle = $("emailUseShippingAmount");
        var shippingInput = $("emailShippingAmount");
        if (shippingInput) {
          shippingInput.disabled = shippingToggle
            ? !(totalsEnabled && isButtonActive("emailUseShippingAmount"))
            : false;
        }
      }

      // ---------- NAV ----------
      function setView(viewId) {
        var views = [
          "view-dashboard",
          "view-order",
          "view-orders",
          "view-products",
        ];
        for (var i = 0; i < views.length; i++) {
          var v = $(views[i]);
          v.className =
            v.className.replace("active", "").replace(/\s+$/, "") ||
            "";
        }
        $(viewId).className += " active";

        var navButtons = [
          "nav-dashboard",
          "nav-order",
          "nav-orders",
          "nav-products",
        ];
        for (var j = 0; j < navButtons.length; j++) {
          var b = $(navButtons[j]);
          b.className = b.className.replace("active", "");
        }
        if (viewId === "view-dashboard")
          $("nav-dashboard").className += " active";
        if (viewId === "view-order")
          $("nav-order").className += " active";
        if (viewId === "view-orders")
          $("nav-orders").className += " active";
        if (viewId === "view-products")
          $("nav-products").className += " active";

        if (viewId === "view-dashboard")
          $("viewLabel").innerHTML = "Dashboard";
        if (viewId === "view-order")
          $("viewLabel").innerHTML = "+ New";
        if (viewId === "view-orders")
          $("viewLabel").innerHTML = "Orders";
        if (viewId === "view-products")
          $("viewLabel").innerHTML = "Products";

        if (viewId === "view-orders") renderOrders();
        if (viewId === "view-products") renderCatalog();
        if (viewId === "view-order") resetOrderFlow();
      }

      $("nav-dashboard").onclick = function () {
        setView("view-dashboard");
      };
      $("nav-order").onclick = function () {
        setView("view-order");
      };
      $("nav-orders").onclick = function () {
        setView("view-orders");
      };
      $("nav-products").onclick = function () {
        setView("view-products");
      };
      $("dash-new-order").onclick = function () {
        setView("view-order");
      };
      $("dash-orders").onclick = function () {
        setView("view-orders");
      };
      $("dash-products").onclick = function () {
        setView("view-products");
      };

      // ---------- DASHBOARD ----------
      function updateDashboard() {
        var orders = getOrders();
        var groupedOrders = groupOrdersByTimestamp(orders);
        var orderCount = groupedOrders.keys.length;
        $("stat-orders").innerHTML = String(orderCount);

        var styleMap = {};
        for (var i = 0; i < catalog.length; i++) {
          var code = (catalog[i].style_code || "").trim();
          if (code) styleMap[code] = true;
        }
        var styleCount = 0;
        for (var k in styleMap) {
          if (styleMap.hasOwnProperty(k)) styleCount++;
        }
        $("stat-styles").innerHTML = String(styleCount);

        if (!orderCount) {
          $("stat-last").innerHTML = "—";
          $("lastActivity").innerHTML = "No orders yet";
        } else {
          var lastKey = groupedOrders.keys[groupedOrders.keys.length - 1];
          var last = groupedOrders.map[lastKey];
          var ts = new Date(last.created_at).toLocaleString();
          $("stat-last").innerHTML = ts;
          $("lastActivity").innerHTML = "Last order: " + ts;
        }
      }

      // ---------- CATALOG STRUCTURE ----------
      function getStyleKey(row) {
        return styleKeyFromParts(row.style_code || "", row.style_name || "");
      }

      function buildStylesIndex() {
        var map = {};
        for (var i = 0; i < catalog.length; i++) {
          var row = catalog[i];
          var key = getStyleKey(row);
          if (!key) continue;
          if (!map[key]) {
            map[key] = {
              key: key,
              code: (row.style_code || "").trim(),
              name: (row.style_name || "").trim(),
              price: row.price || "",
              colors: {},
            };
          }

          var color = (row.color || "").trim();
          var size = (row.size || "").trim();
          if (color) {
            if (!map[key].colors[color]) {
              map[key].colors[color] = { sizes: [] };
            }
            if (
              size &&
              map[key].colors[color].sizes.indexOf(size) === -1
            ) {
              map[key].colors[color].sizes.push(size);
            }
          }
          if (row.price && !map[key].price) map[key].price = row.price;
        }
        return map;
      }

      function orderSizesByPreference(styleKey, sizes) {
        var list = sizes.slice();
        if (!styleKey) return list;
        var meta = styleMeta[styleKey] || {};
        var preferred = meta.sizeOrder || [];
        if (!preferred.length) return list;

        var added = {};
        var ordered = [];

        for (var i = 0; i < preferred.length; i++) {
          var val = preferred[i];
          if (list.indexOf(val) !== -1 && !added[val]) {
            ordered.push(val);
            added[val] = true;
          }
        }

        for (var j = 0; j < list.length; j++) {
          var sz = list[j];
          if (!added[sz]) {
            ordered.push(sz);
            added[sz] = true;
          }
        }

        return ordered;
      }

      // ---------- ORDER FLOW ----------
      function setStep(n) {
        currentStep = n;
        $("order-step-1").style.display = n === 1 ? "block" : "none";
        $("order-step-2").style.display = n === 2 ? "block" : "none";
        $("order-step-3").style.display = n === 3 ? "block" : "none";

        $("step-pill-1").className =
          "step-pill" + (n === 1 ? " active" : "");
        $("step-pill-2").className =
          "step-pill" + (n === 2 ? " active" : "");
        $("step-pill-3").className =
          "step-pill" + (n === 3 ? " active" : "");
      }

      function resetOrderFlow() {
        setStep(1);
        $("custName").value = "";
        $("custClub").value = "";
        $("custEmail").value = "";
        $("custPhone").value = "";
        $("orderNotes").value = "";
        $("styleSearch").value = "";
        selectedStyles = [];
        selectedColors = {};
        renderStylesGrid();
        $("colorsContainer").innerHTML = "";
        $("qtyContainer").innerHTML = "";
      }

      function renderStylesGrid() {
        var stylesMap = buildStylesIndex();
        var grid = $("stylesGrid");
        var empty = $("stylesEmpty");
        grid.innerHTML = "";

        var search = $("styleSearch").value.toLowerCase();
        var any = false;

        for (var key in stylesMap) {
          if (!stylesMap.hasOwnProperty(key)) continue;
          var meta = stylesMap[key];
          var extra = styleMeta[key] || {};
          var imgData = extra.imageDataUrl || "";
          var label =
            (meta.code || "") + " " + (meta.name || "");
          if (search && label.toLowerCase().indexOf(search) === -1) {
            continue;
          }
          any = true;

          var card = document.createElement("div");
          card.className = "style-card";
          card.setAttribute("data-style-key", key);
          if (selectedStyles.indexOf(key) !== -1)
            card.className += " selected";

          var thumb = document.createElement("div");
          thumb.className = "style-thumb";
          if (imgData) {
            var thumbImg = document.createElement("img");
            thumbImg.src = imgData;
            thumb.appendChild(thumbImg);
          } else {
            thumb.innerHTML = "<span>Photo</span>";
          }

          var nameDiv = document.createElement("div");
          nameDiv.className = "style-name";
          nameDiv.innerHTML = meta.name || meta.code || "Unnamed";

          var codeDiv = document.createElement("div");
          codeDiv.className = "style-code";
          codeDiv.innerHTML = meta.code || meta.name || "";

          var metaDiv = document.createElement("div");
          metaDiv.className = "style-meta";
          var colorCount = 0;
          var sizeSet = {};
          for (var c in meta.colors) {
            if (!meta.colors.hasOwnProperty(c)) continue;
            colorCount++;
            for (var i = 0; i < meta.colors[c].sizes.length; i++) {
              var sizeVal = meta.colors[c].sizes[i];
              if (!sizeSet[sizeVal]) sizeSet[sizeVal] = true;
            }
          }
          var sizeCount = 0;
          for (var s in sizeSet) {
            if (!sizeSet.hasOwnProperty(s)) continue;
            sizeCount++;
          }
          metaDiv.innerHTML =
            colorCount +
            " colors • " +
            sizeCount +
            " sizes" +
            (meta.price ? " • $" + meta.price + "/pc" : "");

          card.appendChild(thumb);
          card.appendChild(nameDiv);
          card.appendChild(codeDiv);
          card.appendChild(metaDiv);

          card.onclick = function () {
            var skey = this.getAttribute("data-style-key");
            var idx = selectedStyles.indexOf(skey);
            if (idx === -1) selectedStyles.push(skey);
            else selectedStyles.splice(idx, 1);
            renderStylesGrid();
          };

          grid.appendChild(card);
        }

        empty.style.display = any ? "none" : "block";
      }

      $("styleSearch").oninput = renderStylesGrid;

      $("step1-next").onclick = function () {
        if (!selectedStyles.length) {
          alert("Select at least one style.");
          return;
        }
        renderColorSelection();
        setStep(2);
      };
      $("step2-back").onclick = function () {
        setStep(1);
      };
      $("step2-next").onclick = function () {
        var any = false;
        for (var s in selectedColors) {
          if (!selectedColors.hasOwnProperty(s)) continue;
          var colors = selectedColors[s];
          for (var c in colors) {
            if (colors.hasOwnProperty(c) && colors[c]) {
              any = true;
              break;
            }
          }
        }
        if (!any) {
          alert("Select at least one color.");
          return;
        }
        renderQtySelection();
        setStep(3);
      };
      $("step3-back").onclick = function () {
        setStep(2);
      };
      $("clearOrder").onclick = function () {
        resetOrderFlow();
      };

      function renderColorSelection() {
        var stylesMap = buildStylesIndex();
        var container = $("colorsContainer");
        container.innerHTML = "";

        for (var i = 0; i < selectedStyles.length; i++) {
          var key = selectedStyles[i];
          var meta = stylesMap[key];
          if (!meta) continue;

          if (!selectedColors[key]) selectedColors[key] = {};

          var card = document.createElement("div");
          card.className = "color-card";

          var header = document.createElement("div");
          header.className = "color-header";
          header.innerHTML =
            "<strong>" +
            (meta.name || meta.code || "Style") +
            "</strong><br/><span style='font-size:11px;color:var(--muted)'>" +
            (meta.code || "") +
            "</span>";
          card.appendChild(header);

          var body = document.createElement("div");
          body.className = "color-body";

          var label = document.createElement("label");
          label.innerHTML = "Choose colors";
          body.appendChild(label);

          var list = document.createElement("div");
          list.className = "color-list";

          for (var color in meta.colors) {
            if (!meta.colors.hasOwnProperty(color)) continue;

            var chip = document.createElement("div");
            chip.className = "color-chip";
            chip.setAttribute("data-style-key", key);
            chip.setAttribute("data-color", color);
            if (selectedColors[key][color]) {
              chip.className += " selected";
            }
            chip.innerHTML = color;

            chip.onclick = function () {
              var sk = this.getAttribute("data-style-key");
              var col = this.getAttribute("data-color");
              if (!selectedColors[sk]) selectedColors[sk] = {};
              selectedColors[sk][col] = !selectedColors[sk][col];
              renderColorSelection();
            };

            list.appendChild(chip);
          }

          body.appendChild(list);
          card.appendChild(body);
          container.appendChild(card);
        }

        if (!selectedStyles.length) {
          container.innerHTML =
            "<div class='subtext'>No styles selected.</div>";
        }
      }

      function renderQtySelection() {
        var stylesMap = buildStylesIndex();
        var container = $("qtyContainer");
        container.innerHTML = "";

        for (var i = 0; i < selectedStyles.length; i++) {
          var key = selectedStyles[i];
          var meta = stylesMap[key];
          if (!meta) continue;
          var colorsMap = selectedColors[key] || {};

          for (var color in colorsMap) {
            if (
              !colorsMap.hasOwnProperty(color) ||
              !colorsMap[color]
            )
              continue;

            var sizesInfo = meta.colors[color];
            if (!sizesInfo) continue;

            var card = document.createElement("div");
            card.className = "qty-card";

            var header = document.createElement("div");
            header.className = "qty-header";
            header.innerHTML =
              "<span>" +
              (meta.name || meta.code) +
              " • " +
              color +
              "</span><span>" +
              (meta.price ? "$" + meta.price + "/pc" : "") +
              "</span>";
            card.appendChild(header);

            var grid = document.createElement("div");
            grid.className = "sizes-grid";

            var sizes = orderSizesByPreference(key, sizesInfo.sizes);

            for (var s = 0; s < sizes.length; s++) {
              var size = sizes[s];
              var chip = document.createElement("div");
              chip.className = "size-chip";

              var lab = document.createElement("label");
              lab.innerHTML = size;
              chip.appendChild(lab);

              var input = document.createElement("input");
              input.type = "number";
              input.min = "0";
              input.step = "1";
              input.value = "";
              input.setAttribute("data-style-key", key);
              input.setAttribute("data-color", color);
              input.setAttribute("data-size", size);
              chip.appendChild(input);

              grid.appendChild(chip);
            }

            card.appendChild(grid);
            container.appendChild(card);
          }
        }

        if (!container.innerHTML) {
          container.innerHTML =
            "<div class='subtext'>No colors selected.</div>";
        }
      }

      $("saveOrder").onclick = function () {
        var cust = $("custName").value.replace(/\s+$/, "");
        if (!cust) {
          alert("Customer name is required.");
          return;
        }
        var club = $("custClub").value.replace(/\s+$/, "");
        if (!club) {
          alert("Country club is required.");
          return;
        }
        var email = $("custEmail").value;
        var phone = $("custPhone").value;
        var notes = $("orderNotes").value;

        var inputs = $("qtyContainer").getElementsByTagName("input");
        var lines = [];
        for (var i = 0; i < inputs.length; i++) {
          var el = inputs[i];
          if (!el.getAttribute("data-size")) continue;
          var qty = Number(el.value || 0);
          if (qty <= 0) continue;
          lines.push({
            styleKey: el.getAttribute("data-style-key"),
            color: el.getAttribute("data-color"),
            size: el.getAttribute("data-size"),
            qty: qty,
          });
        }
        if (!lines.length) {
          alert("Enter quantity for at least one size.");
          return;
        }

        var stylesMap = buildStylesIndex();
        var nowIso = new Date().toISOString();
        var orders = getOrders();

        for (var j = 0; j < lines.length; j++) {
          var ln = lines[j];
          var meta = stylesMap[ln.styleKey] || {};
          orders.push({
            created_at: nowIso,
            customer_name: cust,
            customer_club: club,
            customer_email: email,
            customer_phone: phone,
            style_code: meta.code || "",
            style_name: meta.name || "",
            color: ln.color,
            size: ln.size,
            qty: ln.qty,
            notes: notes,
          });
        }

        saveOrdersList(orders);
        renderOrders();
        resetOrderFlow();
        alert("Order saved on this device.");
      };

      // ---------- ORDERS GROUPING + VIEW ----------
      function groupOrdersByTimestamp(orders) {
        var groups = {};
        var keys = [];
        for (var i = 0; i < orders.length; i++) {
          var o = orders[i];
          var key = o.created_at;
          if (!groups[key]) {
            groups[key] = {
              created_at: o.created_at,
              customer_name: o.customer_name,
              customer_club: o.customer_club,
              customer_email: o.customer_email,
              customer_phone: o.customer_phone,
              notes: o.notes,
              lines: [],
              total_qty: 0,
              styles: {},
              colors: {},
              sizes: {},
            };
            keys.push(key);
          }
          var g = groups[key];
          g.lines.push(o);
          g.total_qty += Number(o.qty || 0);
          if (!g.customer_club && o.customer_club) {
            g.customer_club = o.customer_club;
          }

          var sName = o.style_name || o.style_code || "";
          if (sName) g.styles[sName] = true;
          if (o.color) g.colors[o.color] = true;
          if (o.size) g.sizes[o.size] = true;
        }
        keys.sort();
        return { map: groups, keys: keys };
      }

      function escapeRegExp(str) {
        return str.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
      }

      function buildDuplicateCustomerName(baseName, grouped) {
        var name = (baseName || "Order").trim();
        if (!name) name = "Order";

        var pattern = new RegExp(
          "^" + escapeRegExp(name) + "( \\((\\d+)\\))?$"
        );
        var highest = 1;

        for (var i = 0; i < grouped.keys.length; i++) {
          var existingName = (grouped.map[grouped.keys[i]].customer_name || "").trim();
          var match = pattern.exec(existingName);
          if (match) {
            var num = match[2] ? Number(match[2]) : 1;
            if (num >= highest) highest = num;
          }
        }

        return name + " (" + (highest + 1) + ")";
      }

      function renderOrders() {
        var orders = getOrders();
        var table = $("ordersTable");
        var body = $("ordersBody");
        var empty = $("ordersEmpty");
        body.innerHTML = "";

        $("orderDetailPanel").style.display = "none";
        $("orderDetailItems").innerHTML = "";
        $("orderDetailMeta").innerHTML = "";
        $("orderSignatureSection").style.display = "none";
        signatureCurrentTs = null;

        if (!orders.length) {
          table.style.display = "none";
          empty.style.display = "block";
          return;
        }
        table.style.display = "table";
        empty.style.display = "none";

        var grouped = groupOrdersByTimestamp(orders);
        var keys = grouped.keys;
        var groups = grouped.map;

        for (var kIdx = 0; kIdx < keys.length; kIdx++) {
          var gKey = keys[kIdx];
          var g = groups[gKey];

          var styleCount = 0,
            firstStyle = "";
          var colorCount = 0,
            firstColor = "";
          var sizeCount = 0;

          var s;
          for (s in g.styles) {
            if (!g.styles.hasOwnProperty(s)) continue;
            if (!firstStyle) firstStyle = s;
            styleCount++;
          }
          var c;
          for (c in g.colors) {
            if (!g.colors.hasOwnProperty(c)) continue;
            if (!firstColor) firstColor = c;
            colorCount++;
          }
          var z;
          for (z in g.sizes) {
            if (!g.sizes.hasOwnProperty(z)) continue;
            sizeCount++;
          }

          var styleLabel =
            styleCount === 0
              ? ""
              : styleCount === 1
              ? firstStyle
              : "Multiple (" + styleCount + ")";
          var colorLabel =
            colorCount === 0
              ? ""
              : colorCount === 1
              ? firstColor
              : "Multiple (" + colorCount + ")";
          var sizeLabel =
            sizeCount === 0
              ? ""
              : sizeCount === 1
              ? "1 size"
              : sizeCount + " sizes";

          var tr = document.createElement("tr");
          var time = new Date(g.created_at).toLocaleTimeString([], {
            hour: "2-digit",
            minute: "2-digit",
          });

          var customerLabel =
            (g.customer_name || "") +
            (g.customer_club ? " • " + g.customer_club : "");

          tr.innerHTML =
            "<td>" +
            time +
            "</td><td>" +
            customerLabel +
            "</td><td>" +
            styleLabel +
            "</td><td>" +
            colorLabel +
            "</td><td>" +
            sizeLabel +
            "</td><td>" +
            g.total_qty +
            "</td><td>" +
            "<button class='small' data-ts='" +
            g.created_at +
            "' data-action='view'>View</button> " +
            "<button class='secondary small' data-ts='" +
            g.created_at +
            "' data-action='edit'>Edit</button> " +
            "<button class='secondary small' data-ts='" +
            g.created_at +
            "' data-action='duplicate'>Duplicate</button> " +
            "<button class='secondary small' data-ts='" +
            g.created_at +
            "' data-action='csv'>CSV</button> " +
            "<button class='secondary small' data-ts='" +
            g.created_at +
            "' data-action='email'>Email</button>" +
            "</td>";

          body.appendChild(tr);
        }
      }

      $("ordersBody").onclick = function (e) {
        var t = e.target || e.srcElement;
        if (!t || t.tagName.toLowerCase() !== "button") return;
        var ts = t.getAttribute("data-ts");
        var action = t.getAttribute("data-action");
        if (!ts || !action) return;

        if (action === "csv") {
          exportSingleOrderCSV(ts);
        } else if (action === "view") {
          showOrderDetails(ts);
        } else if (action === "edit") {
          openOrderEditor(ts);
        } else if (action === "duplicate") {
          duplicateOrder(ts);
        } else if (action === "email") {
          emailOrder(ts);
        }
      };

      function duplicateOrder(ts) {
        var orders = getOrders();
        var grouped = groupOrdersByTimestamp(orders);
        var group = grouped.map[ts];
        if (!group) return;

        var newTs = new Date().toISOString();
        var newName = buildDuplicateCustomerName(group.customer_name || "", grouped);

        for (var i = 0; i < group.lines.length; i++) {
          var ln = group.lines[i];
          orders.push({
            created_at: newTs,
            customer_name: newName,
            customer_club: group.customer_club,
            customer_email: group.customer_email,
            customer_phone: group.customer_phone,
            style_code: ln.style_code || "",
            style_name: ln.style_name || "",
            color: ln.color || "",
            size: ln.size || "",
            qty: ln.qty,
            notes: group.notes,
          });
        }

        saveOrdersList(orders);
        renderOrders();
      }

      function exportSingleOrderCSV(ts) {
        var orders = getOrders();
        var lines = [];
        for (var i = 0; i < orders.length; i++) {
          if (orders[i].created_at === ts) {
            lines.push(orders[i]);
          }
        }
        if (!lines.length) return;
        var name = lines[0].customer_name || "";
        downloadCSV(lines, "blanco_order_" + name + ".csv");
      }

      // Detail view
      function showOrderDetails(ts) {
        var orders = getOrders();
        var grouped = groupOrdersByTimestamp(orders);
        var g = grouped.map[ts];
        if (!g) return;

        $("orderDetailPanel").style.display = "block";

        var dateStr = new Date(g.created_at).toLocaleString();
        var metaParts = [g.customer_name || "Customer"];
        if (g.customer_club) metaParts.push(g.customer_club);
        metaParts.push(dateStr);
        if (g.customer_email) metaParts.push(g.customer_email);
        if (g.customer_phone) metaParts.push(g.customer_phone);
        if (g.notes) metaParts.push("Notes: " + g.notes);
        $("orderDetailMeta").innerHTML = metaParts.join(" • ");

        var container = $("orderDetailItems");
        container.innerHTML = "";

        // Group lines by style + color
        var itemMap = {};
        var keyOrder = [];
        for (var i = 0; i < g.lines.length; i++) {
          var o = g.lines[i];
          var key =
            (o.style_code || "") +
            "|" +
            (o.style_name || "") +
            "|" +
            (o.color || "");
          if (!itemMap[key]) {
            itemMap[key] = {
              style_name: o.style_name || "",
              style_code: o.style_code || "",
              color: o.color || "",
              sizes: {},
              total_qty: 0,
              unitPrice: getLinePrice(o),
            };
            keyOrder.push(key);
          }
          var item = itemMap[key];
          var size = o.size || "";
          if (!item.sizes[size]) {
            item.sizes[size] = 0;
          }
          item.sizes[size] += Number(o.qty || 0);
          item.total_qty += Number(o.qty || 0);
        }

        for (var k = 0; k < keyOrder.length; k++) {
          var mapItem = itemMap[keyOrder[k]];
          var itemKey = styleKeyFromParts(
            mapItem.style_code,
            mapItem.style_name
          );
          var itemMeta = styleMeta[itemKey] || {};
          var itemImage = itemMeta.imageDataUrl || "";
          var card = document.createElement("div");
          card.className = "order-item-card";

          var thumb = document.createElement("div");
          thumb.className = "order-item-thumb";
          if (itemImage) {
            var thumbImg = document.createElement("img");
            thumbImg.src = itemImage;
            thumb.appendChild(thumbImg);
          } else {
            thumb.innerHTML = "<span>Photo</span>";
          }

          var body = document.createElement("div");
          body.className = "order-item-body";

          var header = document.createElement("div");
          header.className = "order-item-header";

          var left = document.createElement("div");
          var title = document.createElement("div");
          title.className = "order-item-title";
          title.innerHTML =
            mapItem.style_name || mapItem.style_code || "Style";
          var sub = document.createElement("div");
          sub.className = "order-item-subtitle";
          sub.innerHTML = mapItem.style_code || "";
          left.appendChild(title);
          left.appendChild(sub);
          header.appendChild(left);

          var right = document.createElement("div");
          right.className = "order-item-price";
          if (mapItem.unitPrice && emailOpts.includeUnitPrice) {
            var amount =
              mapItem.total_qty * Number(mapItem.unitPrice || 0);
            right.innerHTML =
              "$" +
              Number(mapItem.unitPrice).toFixed(2) +
              " each<br/><strong>$" +
              amount.toFixed(2) +
              "</strong>";
          } else {
            right.innerHTML =
              "Total: <strong>" +
              mapItem.total_qty +
              " pcs</strong>";
          }
          header.appendChild(right);
          body.appendChild(header);

          var tag = document.createElement("div");
          tag.className = "order-tag";
          tag.innerHTML = "Color: " + (mapItem.color || "—");
          body.appendChild(tag);

          var sizeRow = document.createElement("div");
          sizeRow.className = "order-sizes-row";
          for (var size in mapItem.sizes) {
            if (!mapItem.sizes.hasOwnProperty(size)) continue;
            var chip = document.createElement("div");
            chip.className = "order-size-chip";
            chip.innerHTML =
              size + ": " + mapItem.sizes[size] + " pcs";
            sizeRow.appendChild(chip);
          }
          body.appendChild(sizeRow);

          card.appendChild(thumb);
          card.appendChild(body);

          container.appendChild(card);
        }

        signatureCurrentTs = ts;
        var existingSig = getActiveSignature();
        signatureMode = existingSig ? "view" : "edit";
        signatureHasDrawing = false;
        renderSignatureSection();
        resizeSignatureCanvas();
      }

      function getActiveSignature() {
        if (!signatureCurrentTs) return "";
        var signatures = getOrderSignatures();
        return signatures[signatureCurrentTs] || "";
      }

      function resizeSignatureCanvas() {
        var canvas = $("signatureCanvas");
        var box = $("signatureBox");
        if (!canvas || !box) return;

        var width = box.clientWidth || 320;
        var height = box.clientHeight || 190;
        var dpr = window.devicePixelRatio || 1;

        canvas.width = width * dpr;
        canvas.height = height * dpr;
        canvas.style.width = width + "px";
        canvas.style.height = height + "px";

        signatureCtx = canvas.getContext("2d");
        signatureCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
        signatureCtx.lineWidth = 2;
        signatureCtx.lineJoin = "round";
        signatureCtx.lineCap = "round";
        signatureCtx.strokeStyle = "#ffffff";
        signatureCtx.clearRect(0, 0, canvas.width, canvas.height);
      }

      function clearSignatureCanvas() {
        if (!signatureCtx) resizeSignatureCanvas();
        if (!signatureCtx) return;
        var canvas = $("signatureCanvas");
        signatureCtx.clearRect(0, 0, canvas.width, canvas.height);
        signatureHasDrawing = false;
        renderSignatureSection();
      }

      function renderSignatureSection() {
        var section = $("orderSignatureSection");
        if (!section || !signatureCurrentTs) return;

        var existingSig = getActiveSignature();
        section.style.display = "block";

        var canvas = $("signatureCanvas");
        var img = $("signatureImage");
        var placeholder = $("signaturePlaceholder");
        var status = $("signatureStatus");
        var saveBtn = $("signatureSaveBtn");
        var editBtn = $("signatureEditBtn");
        var clearBtn = $("signatureClearBtn");

        if (signatureMode === "view" && existingSig) {
          canvas.style.display = "none";
          canvas.style.pointerEvents = "none";
          img.style.display = "block";
          img.src = existingSig;
          placeholder.style.display = "none";
          status.innerHTML = "Saved signature on file.";
          saveBtn.disabled = true;
          editBtn.disabled = false;
          editBtn.innerHTML = "Edit";
          clearBtn.style.display = "none";
        } else {
          canvas.style.display = "block";
          canvas.style.pointerEvents = "auto";
          img.style.display = "none";
          placeholder.style.display = signatureHasDrawing ? "none" : "flex";
          status.innerHTML = existingSig
            ? "Edit or replace the saved signature."
            : "Have the buyer sign to confirm the order.";
          saveBtn.disabled = false;
          editBtn.innerHTML = existingSig ? "Cancel" : "Edit";
          editBtn.disabled = existingSig ? false : signatureMode === "edit";
          clearBtn.style.display = signatureMode === "edit" ? "inline-flex" : "none";
        }
      }

      function attachSignatureTouchBlockers() {
        if (signatureTouchBlockersAttached) return;
        var canvas = $("signatureCanvas");
        var box = $("signatureBox");
        if (!canvas || !box) return;

        var blockTouch = function (e) {
          if (e.cancelable) e.preventDefault();
        };

        ["touchstart", "touchmove", "touchend", "touchcancel"].forEach(
          function (evt) {
            canvas.addEventListener(evt, blockTouch, { passive: false });
            box.addEventListener(evt, blockTouch, { passive: false });
          }
        );

        signatureTouchBlockersAttached = true;
      }

      function attachSignatureScrollBlocker() {
        if (signatureScrollBlockerAttached) return;
        var block = function (e) {
          if (signatureDrawing && e.cancelable) e.preventDefault();
        };
        document.addEventListener("touchmove", block, { passive: false });
        document.addEventListener("touchstart", block, { passive: false });
        signatureScrollBlockerAttached = true;
        attachSignatureScrollBlocker._handler = block;
      }

      function detachSignatureScrollBlocker() {
        if (!signatureScrollBlockerAttached) return;
        var block = attachSignatureScrollBlocker._handler;
        if (block) {
          document.removeEventListener("touchmove", block, { passive: false });
          document.removeEventListener("touchstart", block, { passive: false });
        }
        signatureScrollBlockerAttached = false;
      }

      function startSignatureDraw(e) {
        if (signatureMode !== "edit") return;
        if (!signatureCtx) resizeSignatureCanvas();
        if (!signatureCtx) return;
        if (e.preventDefault) e.preventDefault();
        attachSignatureScrollBlocker();
        signatureDrawing = true;
        signatureHasDrawing = true;
        var rect = $("signatureCanvas").getBoundingClientRect();
        signatureCtx.beginPath();
        signatureCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        $("signaturePlaceholder").style.display = "none";
      }

      function continueSignatureDraw(e) {
        if (!signatureDrawing || signatureMode !== "edit") return;
        if (!signatureCtx) return;
        if (e.preventDefault) e.preventDefault();
        var rect = $("signatureCanvas").getBoundingClientRect();
        signatureCtx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
        signatureCtx.stroke();
      }

      function endSignatureDraw() {
        if (!signatureDrawing) return;
        signatureDrawing = false;
        detachSignatureScrollBlocker();
      }

      function saveSignature() {
        if (signatureMode !== "edit") return;
        if (!signatureHasDrawing) {
          alert("Add a signature before saving.");
          return;
        }
        var canvas = $("signatureCanvas");
        if (!canvas) return;
        var dataUrl = canvas.toDataURL("image/png");
        if (!dataUrl) return;
        var signatures = getOrderSignatures();
        signatures[signatureCurrentTs] = dataUrl;
        saveOrderSignatures(signatures);
        signatureMode = "view";
        signatureHasDrawing = false;
        renderSignatureSection();
      }

      var editingOrderTs = null;

      function addOrderEditLineRow(line) {
        var container = $("orderEditLines");
        var row = document.createElement("div");
        row.className = "edit-line";

        var header = document.createElement("div");
        header.className = "edit-line-header";

        function buildField(label, placeholder, field, value) {
          var wrap = document.createElement("div");
          var lab = document.createElement("label");
          lab.innerHTML = label;
          var input = document.createElement("input");
          input.placeholder = placeholder;
          input.value = value || "";
          input.setAttribute("data-field", field);
          wrap.appendChild(lab);
          wrap.appendChild(input);
          return { wrap: wrap, input: input };
        }

        var styleNameField = buildField(
          "Product name",
          "Product name",
          "style-name",
          (line && line.style_name) || ""
        );
        var styleCodeField = buildField(
          "Style code (optional)",
          "Code",
          "style-code",
          (line && line.style_code) || ""
        );
        var colorField = buildField(
          "Color",
          "Color",
          "color",
          (line && line.color) || ""
        );

        header.appendChild(styleNameField.wrap);
        header.appendChild(styleCodeField.wrap);
        header.appendChild(colorField.wrap);

        row.appendChild(header);

        var sizesLabel = document.createElement("div");
        sizesLabel.className = "edit-line-label";
        sizesLabel.innerHTML = "Sizes & qty";
        row.appendChild(sizesLabel);

        var sizeGrid = document.createElement("div");
        sizeGrid.className = "sizes-grid";

        function addSizeChip(sizeVal, qtyVal) {
          var chip = document.createElement("div");
          chip.className = "size-chip edit-size-chip";

          var sizeInput = document.createElement("input");
          sizeInput.type = "text";
          sizeInput.placeholder = "Size";
          sizeInput.value = sizeVal || "";
          sizeInput.setAttribute("data-field", "size");
          chip.appendChild(sizeInput);

          var qtyInput = document.createElement("input");
          qtyInput.type = "number";
          qtyInput.min = "0";
          qtyInput.step = "1";
          qtyInput.placeholder = "Qty";
          qtyInput.value = qtyVal > 0 ? qtyVal : "";
          qtyInput.setAttribute("data-field", "qty");
          chip.appendChild(qtyInput);

          sizeGrid.appendChild(chip);
        }

        var sizeMap = (line && line.sizes) || {};
        var sizeNames = [];
        for (var sz in sizeMap) {
          if (!sizeMap.hasOwnProperty(sz)) continue;
          sizeNames.push(sz);
        }

        var styleKey = styleKeyFromParts(
          (line && line.style_code) || "",
          (line && line.style_name) || ""
        );
        var orderedSizes = sizeNames.length
          ? orderSizesByPreference(styleKey, sizeNames)
          : [];

        if (!orderedSizes.length) orderedSizes.push("");

        for (var idx = 0; idx < orderedSizes.length; idx++) {
          var szKey = orderedSizes[idx];
          addSizeChip(szKey, sizeMap[szKey] || 0);
        }

        row.appendChild(sizeGrid);

        var lineActions = document.createElement("div");
        lineActions.className = "edit-line-actions";

        var sizeActions = document.createElement("div");
        sizeActions.className = "edit-size-actions";
        var addSizeBtn = document.createElement("button");
        addSizeBtn.className = "secondary small";
        addSizeBtn.innerHTML = "+ Add size";
        addSizeBtn.onclick = function () {
          addSizeChip("", "");
        };
        sizeActions.appendChild(addSizeBtn);

        var actions = document.createElement("div");
        var removeBtn = document.createElement("button");
        removeBtn.className = "secondary small";
        removeBtn.innerHTML = "Remove product";
        removeBtn.onclick = function () {
          container.removeChild(row);
        };
        actions.appendChild(removeBtn);

        lineActions.appendChild(sizeActions);
        lineActions.appendChild(actions);

        row.appendChild(lineActions);

        container.appendChild(row);
      }

      function groupLinesForEditor(lines) {
        var groups = [];
        var map = {};
        for (var i = 0; i < lines.length; i++) {
          var ln = lines[i];
          var key =
            styleKeyFromParts(ln.style_code || "", ln.style_name || "") +
            "::" +
            (ln.color || "");
          if (!map[key]) {
            map[key] = {
              style_name: ln.style_name || "",
              style_code: ln.style_code || "",
              color: ln.color || "",
              sizes: {},
            };
            groups.push(map[key]);
          }
          var sizeKey = ln.size || "";
          var qtyVal = Number(ln.qty || 0);
          if (!map[key].sizes[sizeKey]) map[key].sizes[sizeKey] = 0;
          map[key].sizes[sizeKey] += qtyVal;
        }
        return groups;
      }

      function openOrderEditor(ts) {
        var orders = getOrders();
        var grouped = groupOrdersByTimestamp(orders);
        var g = grouped.map[ts];
        if (!g) return;

        editingOrderTs = ts;

        $("orderEditName").value = g.customer_name || "";
        $("orderEditClub").value = g.customer_club || "";
        $("orderEditEmail").value = g.customer_email || "";
        $("orderEditPhone").value = g.customer_phone || "";
        $("orderEditNotes").value = g.notes || "";

        var container = $("orderEditLines");
        container.innerHTML = "";
        var groupedLines = groupLinesForEditor(g.lines || []);
        if (groupedLines.length) {
          for (var i = 0; i < groupedLines.length; i++) {
            addOrderEditLineRow(groupedLines[i]);
          }
        } else {
          addOrderEditLineRow();
        }

        $("orderEditModal").style.display = "flex";
      }

      function closeOrderEditor() {
        editingOrderTs = null;
        $("orderEditModal").style.display = "none";
      }

      $("orderEditAddLine").onclick = function () {
        addOrderEditLineRow();
      };

      $("orderEditClose").onclick = function () {
        closeOrderEditor();
      };

      $("orderEditCancel").onclick = function () {
        closeOrderEditor();
      };

      $("orderEditSave").onclick = function () {
        if (!editingOrderTs) return;
        var cust = $("orderEditName").value.replace(/\s+$/, "");
        if (!cust) {
          alert("Customer name is required.");
          return;
        }
        var club = $("orderEditClub").value.replace(/\s+$/, "");
        if (!club) {
          alert("Country club is required.");
          return;
        }
        var email = $("orderEditEmail").value;
        var phone = $("orderEditPhone").value;
        var notes = $("orderEditNotes").value;

        var rows = $("orderEditLines").getElementsByClassName("edit-line");
        var newLines = [];
        for (var i = 0; i < rows.length; i++) {
          var r = rows[i];
          var styleName = (r.querySelector('[data-field=\"style-name\"]').value || "").trim();
          var styleCode = (r.querySelector('[data-field=\"style-code\"]').value || "").trim();
          var color = (r.querySelector('[data-field=\"color\"]').value || "").trim();
          var sizeChips = r.getElementsByClassName("edit-size-chip");

          for (var sIdx = 0; sIdx < sizeChips.length; sIdx++) {
            var chip = sizeChips[sIdx];
            var sizeInput = chip.querySelector('[data-field=\"size\"]');
            var qtyInput = chip.querySelector('[data-field=\"qty\"]');
            if (!sizeInput || !qtyInput) continue;
            var size = (sizeInput.value || "").trim();
            var qtyVal = Number(qtyInput.value || 0);
            if (!(qtyVal > 0)) continue;
            if (!styleName && !styleCode) continue;
            newLines.push({
              style_name: styleName,
              style_code: styleCode,
              color: color,
              size: size,
              qty: qtyVal,
            });
          }
        }

        if (!newLines.length) {
          alert("Add at least one product line with quantity.");
          return;
        }

        var orders = getOrders();
        var filtered = [];
        for (var j = 0; j < orders.length; j++) {
          if (orders[j].created_at !== editingOrderTs) {
            filtered.push(orders[j]);
          }
        }

        for (var k = 0; k < newLines.length; k++) {
          var ln = newLines[k];
          filtered.push({
            created_at: editingOrderTs,
            customer_name: cust,
            customer_club: club,
            customer_email: email,
            customer_phone: phone,
            style_code: ln.style_code || "",
            style_name: ln.style_name || "",
            color: ln.color || "",
            size: ln.size || "",
            qty: ln.qty,
            notes: notes,
          });
        }

        saveOrdersList(filtered);
        renderOrders();
        showOrderDetails(editingOrderTs);
        closeOrderEditor();
      };

      function getLinePrice(o) {
        // look up in catalog by style + color + size
        for (var i = 0; i < catalog.length; i++) {
          var r = catalog[i];
          if (
            (r.style_code || "") === (o.style_code || "") &&
            (r.style_name || "") === (o.style_name || "") &&
            (r.color || "") === (o.color || "") &&
            (r.size || "") === (o.size || "")
          ) {
            return r.price || "";
          }
        }
        return "";
      }

      function emailOrder(ts) {
        var orders = getOrders();
        var grouped = groupOrdersByTimestamp(orders);
        var g = grouped.map[ts];
        if (!g) return;

        var subjectPrefix =
          (emailOpts && emailOpts.subjectPrefix) || "BLANCO order";
        var subject =
          subjectPrefix +
          " – " +
          (g.customer_name || "Customer") +
          " – " +
          new Date(g.created_at).toLocaleDateString();

        var body = buildOrderEmailBody(g, emailOpts);

        var to = g.customer_email || "";
        var url =
          "mailto:" +
          encodeURIComponent(to) +
          "?subject=" +
          encodeURIComponent(subject) +
          "&body=" +
          encodeURIComponent(body);

        window.location.href = url;
      }

      function escapeHtml(str) {
        if (str === null || str === undefined) return "";
        return String(str)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function formatMoney(val) {
        var num = Number(val || 0);
        if (isNaN(num)) num = 0;
        return "$" + num.toFixed(2);
      }

      function buildOrderEmailBody(group, opts) {
        var lines = [];
        var heading = (opts && opts.headingLine) || "BLANCO Clothing – Order";
        if (heading) lines.push(heading);
        lines.push("");
        if (opts && opts.introMessage) {
          lines.push(opts.introMessage);
          lines.push("");
        }
        lines.push("Customer: " + (group.customer_name || ""));
        if (group.customer_club)
          lines.push("Country club: " + group.customer_club);
        if (group.customer_email) lines.push("Email: " + group.customer_email);
        if (group.customer_phone) lines.push("Phone: " + group.customer_phone);
        lines.push("Date: " + new Date(group.created_at).toLocaleString());

        if (!opts || opts.includeTotalQty !== false) {
          lines.push("Total pieces: " + (group.total_qty || 0));
        }

        lines.push("");
        lines.push("Items:");
        lines.push("");

        // group by style/color
        var itemMap = {};
        var keyOrder = [];
        var subtotalAmount = 0;
        var hasPricedLines = false;
        for (var i = 0; i < group.lines.length; i++) {
          var o = group.lines[i];
          var key =
            (o.style_code || "") +
            "|" +
            (o.style_name || "") +
            "|" +
            (o.color || "");
          if (!itemMap[key]) {
            var metaKey = styleKeyFromParts(o.style_code || "", o.style_name || "");
            var meta = (styleMeta && metaKey && styleMeta[metaKey]) || {};
            itemMap[key] = {
              style_name: o.style_name || "",
              style_code: o.style_code || "",
              styleKey: metaKey,
              color: o.color || "",
              sizes: {},
              total_qty: 0,
              unitPrice: getLinePrice(o),
              image: meta.imageDataUrl || "",
            };
            keyOrder.push(key);
          }
          var item = itemMap[key];
          var size = o.size || "";
          if (!item.sizes[size]) item.sizes[size] = 0;
          item.sizes[size] += Number(o.qty || 0);
          item.total_qty += Number(o.qty || 0);
          var unitPriceNum = Number(
            item.unitPrice === "" || item.unitPrice === null
              ? NaN
              : item.unitPrice
          );
          if (!isNaN(unitPriceNum)) {
            hasPricedLines = true;
            subtotalAmount += unitPriceNum * Number(o.qty || 0);
          }
        }
        for (var k = 0; k < keyOrder.length; k++) {
          var item = itemMap[keyOrder[k]];
          var amountTotal = 0;
          if (opts && opts.includeUnitPrice && item.unitPrice) {
            amountTotal = item.total_qty * Number(item.unitPrice || 0);
          }
          var orderedSizes = orderSizesByPreference(
            item.styleKey,
            Object.keys(item.sizes)
          );
          var label = "- " + (item.style_name || item.style_code || "Style");
          if (item.style_code) label += " (" + item.style_code + ")";
          lines.push(label);
          if (item.color) {
            lines.push("  Color: " + item.color);
          }

          if (orderedSizes.length) {
            var sizeParts = [];
            for (var h = 0; h < orderedSizes.length; h++) {
              var sz = orderedSizes[h];
              sizeParts.push((sz || "-") + " x " + (item.sizes[sz] || 0));
            }
            lines.push("  Sizes: " + sizeParts.join(", "));
          }

          if (opts && opts.includeUnitPrice && item.unitPrice) {
            lines.push(
              "  Qty: " +
                item.total_qty +
                " • Unit: " +
                formatMoney(item.unitPrice) +
                " • Amount: " +
                formatMoney(amountTotal)
            );
          } else {
            lines.push("  Total pieces: " + item.total_qty);
          }

          lines.push("");
        }

        if (opts && opts.includeTotalsSummary) {
          var taxAmount = opts.includeTaxAmount ? Number(opts.taxAmount || 0) : 0;
          var shippingAmount = opts.includeShippingAmount
            ? Number(opts.shippingAmount || 0)
            : 0;
          if (isNaN(taxAmount)) taxAmount = 0;
          if (isNaN(shippingAmount)) shippingAmount = 0;
          var totalAmount = hasPricedLines
            ? subtotalAmount + taxAmount + shippingAmount
            : null;
          lines.push("Totals:");
          lines.push(
            "Subtotal: " + (hasPricedLines ? formatMoney(subtotalAmount) : "N/A")
          );
          if (opts.includeTaxAmount) {
            lines.push("Tax: " + formatMoney(taxAmount));
          }
          if (opts.includeShippingAmount) {
            lines.push("Shipping: " + formatMoney(shippingAmount));
          }
          lines.push(
            "Total: " + (totalAmount !== null ? formatMoney(totalAmount) : "N/A")
          );
          lines.push("");
        }

        if (opts && opts.includeNotes && group.notes) {
          lines.push("Notes:");
          lines.push(group.notes);
          lines.push("");
        }

        var footer =
          (opts && opts.footerLine) || "Generated from BLANCO offline order app.";
        if (footer) lines.push(footer);
        return lines.join("\n");
      }

      function buildOrderHTML(group, opts) {
        var heading =
          (opts && opts.headingLine) || "BLANCO Clothing – Order";
        var intro = opts && opts.introMessage ? opts.introMessage : "";
        var footer =
          (opts && opts.footerLine) || "Generated from BLANCO offline order app.";

        var itemMap = {};
        var keyOrder = [];
        var subtotalAmount = 0;
        var hasPricedLines = false;

        for (var i = 0; i < group.lines.length; i++) {
          var o = group.lines[i];
          var key =
            (o.style_code || "") +
            "|" +
            (o.style_name || "") +
            "|" +
            (o.color || "");
          if (!itemMap[key]) {
            var metaKey = styleKeyFromParts(o.style_code || "", o.style_name || "");
            var meta = (styleMeta && metaKey && styleMeta[metaKey]) || {};
            itemMap[key] = {
              style_name: o.style_name || "",
              style_code: o.style_code || "",
              styleKey: metaKey,
              color: o.color || "",
              sizes: {},
              total_qty: 0,
              unitPrice: getLinePrice(o),
              image: meta.imageDataUrl || "",
            };
            keyOrder.push(key);
          }
          var item = itemMap[key];
          var size = o.size || "";
          if (!item.sizes[size]) item.sizes[size] = 0;
          item.sizes[size] += Number(o.qty || 0);
          item.total_qty += Number(o.qty || 0);
          var unitPriceNum = Number(
            item.unitPrice === "" || item.unitPrice === null
              ? NaN
              : item.unitPrice
          );
          if (!isNaN(unitPriceNum)) {
            hasPricedLines = true;
            subtotalAmount += unitPriceNum * Number(o.qty || 0);
          }
        }

        var itemsHtml = "";
        for (var k = 0; k < keyOrder.length; k++) {
          var item = itemMap[keyOrder[k]];
          var orderedSizes = orderSizesByPreference(
            item.styleKey,
            Object.keys(item.sizes)
          );
          var amountTotal = 0;
          if (opts && opts.includeUnitPrice && item.unitPrice) {
            amountTotal = item.total_qty * Number(item.unitPrice || 0);
          }

          var styleLabel = escapeHtml(item.style_name || item.style_code || "Style");
          var styleCodeTag = item.style_code
            ? " <span class='muted'>(" + escapeHtml(item.style_code) + ")</span>"
            : "";

          var sizeHead = "";
          var sizeRow = "";
          for (var h = 0; h < orderedSizes.length; h++) {
            var sz = orderedSizes[h];
            sizeHead +=
              "<th>" + escapeHtml(sz || "-") + "</th>";
            sizeRow +=
              "<td>" + escapeHtml(item.sizes[sz] || 0) + "</td>";
          }

          itemsHtml += "<div class='item-card'>";
          itemsHtml += "  <div class='item-body'>";
          if (item.image) {
            itemsHtml +=
              "<div class='item-photo'><img src='" +
              item.image +
              "' alt='Style photo' /></div>";
          }
          itemsHtml += "    <div class='item-content'>";
          itemsHtml +=
            "      <div class='item-title'>" +
            styleLabel +
            styleCodeTag +
            "</div>";
          itemsHtml +=
            "      <div class='item-sub'>Color: " +
            escapeHtml(item.color || "") +
            "</div>";

          if (orderedSizes.length) {
            itemsHtml += "      <table class='size-table'><thead><tr>" + sizeHead + "</tr></thead>";
            itemsHtml += "      <tbody><tr>" + sizeRow + "</tr></tbody></table>";
          }

          if (opts && opts.includeUnitPrice && item.unitPrice) {
            itemsHtml +=
              "      <div class='item-meta'>Qty: " +
              item.total_qty +
              " • Unit: " +
              formatMoney(item.unitPrice) +
              " • Amount: " +
              formatMoney(amountTotal) +
              "</div>";
          } else {
            itemsHtml +=
              "      <div class='item-meta'>Total pieces: " +
              item.total_qty +
              "</div>";
          }

          itemsHtml += "    </div>";
          itemsHtml += "  </div>";
          itemsHtml += "</div>";
        }

        var showSummary = !opts || opts.showTotalsSummary !== false;
        if (
          opts &&
          opts.includeTotalQty === false &&
          opts.includeTotalsSummary === false
        ) {
          showSummary = false;
        }
        var taxAmount =
          opts && opts.includeTaxAmount
            ? Number(opts.taxAmount || 0)
            : 0;
        var shippingAmount =
          opts && opts.includeShippingAmount
            ? Number(opts.shippingAmount || 0)
            : 0;
        if (isNaN(taxAmount)) taxAmount = 0;
        if (isNaN(shippingAmount)) shippingAmount = 0;
        var totalAmount = hasPricedLines
          ? subtotalAmount + taxAmount + shippingAmount
          : null;

        var summaryHtml = "";
        if (showSummary) {
          summaryHtml += "<div class='summary'>";
          summaryHtml += "  <div class='summary-title'>Totals</div>";
          if (!opts || opts.includeTotalQty !== false) {
            summaryHtml +=
              "  <div class='summary-row'><span>Qty total</span><strong>" +
              escapeHtml(group.total_qty || 0) +
              "</strong></div>";
          }
          if (!opts || opts.includeTotalsSummary) {
            summaryHtml +=
              "  <div class='summary-row'><span>Subtotal</span><strong>" +
              (hasPricedLines ? formatMoney(subtotalAmount) : "N/A") +
              "</strong></div>";
            if (opts.includeTaxAmount) {
              summaryHtml +=
                "  <div class='summary-row'><span>Tax</span><strong>" +
                formatMoney(taxAmount) +
                "</strong></div>";
            }
            if (opts.includeShippingAmount) {
              summaryHtml +=
                "  <div class='summary-row'><span>Shipping</span><strong>" +
                formatMoney(shippingAmount) +
                "</strong></div>";
            }
            summaryHtml +=
              "  <div class='summary-row'><span>Total</span><strong>" +
              (totalAmount !== null ? formatMoney(totalAmount) : "N/A") +
              "</strong></div>";
          }
          summaryHtml += "</div>";
        }

        var notesHtml = "";
        if (opts && opts.includeNotes && group.notes) {
          notesHtml += "<div class='notes'>";
          notesHtml += "  <div class='notes-title'>Order notes</div>";
          notesHtml +=
            "  <div class='notes-body'>" +
            escapeHtml(group.notes).replace(/\n/g, "<br />") +
            "</div>";
          notesHtml += "</div>";
        }

        var html = "";
        html += "<div class='doc'>";
        html += "  <div class='heading'>" + escapeHtml(heading) + "</div>";
        if (intro) {
          html += "  <p class='intro'>" + escapeHtml(intro) + "</p>";
        }
        html += "  <div class='meta-grid'>";
        html +=
          "    <div><div class='label'>Customer</div><div class='value'>" +
          escapeHtml(group.customer_name || "") +
          "</div></div>";
        if (group.customer_club)
          html +=
            "    <div><div class='label'>Country club</div><div class='value'>" +
            escapeHtml(group.customer_club) +
            "</div></div>";
        if (group.customer_email)
          html +=
            "    <div><div class='label'>Email</div><div class='value'>" +
            escapeHtml(group.customer_email) +
            "</div></div>";
        if (group.customer_phone)
          html +=
            "    <div><div class='label'>Phone</div><div class='value'>" +
            escapeHtml(group.customer_phone) +
            "</div></div>";
        html +=
          "    <div><div class='label'>Date</div><div class='value'>" +
          escapeHtml(new Date(group.created_at).toLocaleString()) +
          "</div></div>";
        if (!opts || opts.includeTotalQty !== false)
          html +=
            "    <div><div class='label'>Total pieces</div><div class='value'>" +
            escapeHtml(group.total_qty || 0) +
            "</div></div>";
        html += "  </div>";

        html += "  <div class='section-title'>Items</div>";
        html += itemsHtml;

        html += notesHtml;
        html += summaryHtml;

        if (footer) {
          html += "  <div class='footer'>" + escapeHtml(footer) + "</div>";
        }
        html += "</div>";

        return html;
      }

      $("exportOrders").onclick = function () {
        var orders = getOrders();
        if (!orders.length) {
          alert("No orders to export.");
          return;
        }
        downloadCSV(
          orders,
          "blanco_orders_" +
            new Date().toISOString().slice(0, 10) +
            ".csv"
        );
      };

      function buildOrdersCSV(orders) {
        var headers = [
          "created_at",
          "customer_name",
          "customer_club",
          "customer_email",
          "customer_phone",
          "style_code",
          "style_name",
          "color",
          "size",
          "qty",
          "notes",
        ];
        var rows = [headers];

        for (var i = 0; i < orders.length; i++) {
          var o = orders[i];
          rows.push([
            o.created_at || "",
            o.customer_name || "",
            o.customer_club || "",
            o.customer_email || "",
            o.customer_phone || "",
            o.style_code || "",
            o.style_name || "",
            o.color || "",
            o.size || "",
            o.qty || "",
            (o.notes || "").replace(/\n/g, " "),
          ]);
        }

        var lines = [];
        for (var r = 0; r < rows.length; r++) {
          var row = rows[r];
          for (var c = 0; c < row.length; c++) {
            row[c] =
              '"' + String(row[c]).replace(/"/g, '""') + '"';
          }
          lines.push(row.join(","));
        }
        return lines.join("\n");
      }

      function downloadCSV(orders, filename) {
        var csv = buildOrdersCSV(orders);
        var bom = new Uint8Array([0xef, 0xbb, 0xbf]);
        var blob = new Blob([bom, csv], {
          type: "text/csv;charset=utf-8;",
        });
        var url = URL.createObjectURL(blob);
        var a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // ---------- CATALOG VIEW (cards + modal) ----------
      function styleKeyFromParts(code, name) {
        var cleanCode = (code || "").trim();
        var cleanName = (name || "").trim();
        if (!cleanCode && !cleanName) return "";
        return cleanCode + "::" + cleanName;
      }

      function buildStylesIndexForProducts() {
        var map = {};
        for (var i = 0; i < catalog.length; i++) {
          var row = catalog[i];
          var code = (row.style_code || "").trim();
          var name = (row.style_name || "").trim();
          var key = styleKeyFromParts(code, name);
          if (!key) continue;
          if (!map[key]) {
            map[key] = {
              key: key,
              code: code,
              name: name,
              price: row.price || "",
              colors: {},
            };
          }
          var color = (row.color || "").trim();
          var size = (row.size || "").trim();
          if (color) {
            if (!map[key].colors[color]) {
              map[key].colors[color] = [];
            }
            if (size && map[key].colors[color].indexOf(size) === -1) {
              map[key].colors[color].push(size);
            }
          }
          if (row.price && !map[key].price) map[key].price = row.price;
        }
        return map;
      }

      function renderProductsGrid() {
        var grid = $("productsGrid");
        var empty = $("productsEmpty");
        grid.innerHTML = "";

        var stylesMap = buildStylesIndexForProducts();
        var any = false;

        for (var key in stylesMap) {
          if (!stylesMap.hasOwnProperty(key)) continue;
          any = true;
          var meta = stylesMap[key];

          var metaExtra = styleMeta[key] || {};
          var imgData = metaExtra.imageDataUrl || "";

          var colorCount = 0;
          var sizeSet = {};
          for (var c in meta.colors) {
            if (!meta.colors.hasOwnProperty(c)) continue;
            colorCount++;
            for (var i = 0; i < meta.colors[c].length; i++) {
              var sizeVal = meta.colors[c][i];
              if (!sizeSet[sizeVal]) sizeSet[sizeVal] = true;
            }
          }
          var sizeCount = 0;
          for (var s in sizeSet) {
            if (!sizeSet.hasOwnProperty(s)) continue;
            sizeCount++;
          }

          var card = document.createElement("div");
          card.className = "product-card";

          var imgDiv = document.createElement("div");
          imgDiv.className = "product-image";
          if (imgData) {
            var img = document.createElement("img");
            img.src = imgData;
            imgDiv.appendChild(img);
          } else {
            imgDiv.innerHTML = "<span>Photo</span>";
          }
          card.appendChild(imgDiv);

          var nameDiv = document.createElement("div");
          nameDiv.className = "product-name";
          nameDiv.innerHTML = meta.name || meta.code || "Unnamed style";
          card.appendChild(nameDiv);

          var codeDiv = document.createElement("div");
          codeDiv.className = "product-code";
          codeDiv.innerHTML = meta.code || meta.name || "";
          card.appendChild(codeDiv);

          var summary = document.createElement("div");
          summary.className = "product-summary";
          summary.innerHTML =
            colorCount +
            " colors • " +
            sizeCount +
            " sizes" +
            (meta.price ? " • $" + meta.price : "");
          card.appendChild(summary);

          var actions = document.createElement("div");
          actions.className = "product-actions";

          var editBtn = document.createElement("button");
          editBtn.className = "secondary small";
          editBtn.innerHTML = "Edit";
          editBtn.setAttribute("data-style-key", key);
          editBtn.setAttribute("data-action", "edit");
          actions.appendChild(editBtn);

          var dupBtn = document.createElement("button");
          dupBtn.className = "secondary small";
          dupBtn.innerHTML = "Duplicate";
          dupBtn.setAttribute("data-style-key", key);
          dupBtn.setAttribute("data-action", "duplicate");
          actions.appendChild(dupBtn);

          var delBtn = document.createElement("button");
          delBtn.className = "danger small";
          delBtn.innerHTML = "Delete";
          delBtn.setAttribute("data-style-key", key);
          delBtn.setAttribute("data-action", "delete");
          actions.appendChild(delBtn);

          card.appendChild(actions);
          grid.appendChild(card);
        }

        empty.style.display = any ? "none" : "block";
      }

      var editingStyleKey = null;
      var modalColors = [];
      var modalSizes = [];
      var modalImageDataUrl = "";

      function openStyleModal(styleKey, isDuplicate) {
        var stylesMap = buildStylesIndexForProducts();
        editingStyleKey = isDuplicate ? null : styleKey || null;
        modalColors = [];
        modalSizes = [];
        modalImageDataUrl = "";

        if (styleKey && stylesMap[styleKey]) {
          var s = stylesMap[styleKey];
          var extra = styleMeta[styleKey] || {};

          if (isDuplicate) {
            $("modalTitle").innerHTML = "Duplicate style";
            $("modalStyleName").value =
              (s.name || "") + " (Copy)";
            $("modalStyleCode").value = s.code
              ? s.code + "-COPY"
              : "";
          } else {
            $("modalTitle").innerHTML = "Edit style";
            $("modalStyleName").value = s.name || "";
            $("modalStyleCode").value = s.code || "";
          }

          $("modalPrice").value = s.price || "";
          $("modalDescription").value = extra.description || "";
          $("modalCategory").value = extra.category || "";
          modalImageDataUrl = extra.imageDataUrl || "";
          $("modalInStock").checked =
            extra.hasOwnProperty("in_stock")
              ? !!extra.in_stock
              : true;

          var cMap = s.colors;
          var c;
          for (c in cMap) {
            if (!cMap.hasOwnProperty(c)) continue;
            if (modalColors.indexOf(c) === -1) modalColors.push(c);
            var szs = cMap[c];
            for (var i = 0; i < szs.length; i++) {
              var size = szs[i];
              if (modalSizes.indexOf(size) === -1)
                modalSizes.push(size);
            }
          }

          modalSizes = orderSizesByPreference(styleKey, modalSizes);
        } else {
          $("modalTitle").innerHTML = "New style";
          $("modalStyleName").value = "";
          $("modalStyleCode").value = "";
          $("modalPrice").value = "";
          $("modalDescription").value = "";
          $("modalCategory").value = "";
          $("modalInStock").checked = true;
        }

        renderModalChips();
        renderModalImagePreview();

        $("styleModal").style.display = "flex";
      }

      function closeStyleModal() {
        $("styleModal").style.display = "none";
      }

      function renderModalChips() {
        var colorsRow = $("modalColorsRow");
        var sizesRow = $("modalSizesRow");
        colorsRow.innerHTML = "";
        sizesRow.innerHTML = "";

        var i;
        for (i = 0; i < modalColors.length; i++) {
          (function (idx) {
            var chip = document.createElement("span");
            chip.className = "chip";
            chip.innerHTML =
              modalColors[idx] +
              ' <button type="button" data-type="color" data-idx="' +
              idx +
              '">×</button>';
            colorsRow.appendChild(chip);
          })(i);
        }

        for (i = 0; i < modalSizes.length; i++) {
          (function (idx2) {
            var chip = document.createElement("span");
            chip.className = "chip";
            chip.innerHTML =
              '<span class="chip-label">' +
              modalSizes[idx2] +
              '</span><span class="chip-actions">' +
              ' <button type="button" data-action="up" data-idx="' +
              idx2 +
              '">↑</button>' +
              ' <button type="button" data-action="down" data-idx="' +
              idx2 +
              '">↓</button>' +
              ' <button type="button" data-action="remove" data-idx="' +
              idx2 +
              '">×</button>' +
              "</span>";
            sizesRow.appendChild(chip);
          })(i);
        }
      }

      $("modalColorsRow").onclick = function (e) {
        var t = e.target || e.srcElement;
        if (t.tagName.toLowerCase() !== "button") return;
        var type = t.getAttribute("data-type");
        var idx = Number(t.getAttribute("data-idx"));
        if (type === "color") {
          modalColors.splice(idx, 1);
        }
        renderModalChips();
      };

      $("modalSizesRow").onclick = function (e) {
        var t = e.target || e.srcElement;
        if (t.tagName.toLowerCase() !== "button") return;
        var action = t.getAttribute("data-action");
        var idx = Number(t.getAttribute("data-idx"));

        if (action === "remove") {
          modalSizes.splice(idx, 1);
        } else if (action === "up" && idx > 0) {
          var tmp = modalSizes[idx - 1];
          modalSizes[idx - 1] = modalSizes[idx];
          modalSizes[idx] = tmp;
        } else if (action === "down" && idx < modalSizes.length - 1) {
          var tmp2 = modalSizes[idx + 1];
          modalSizes[idx + 1] = modalSizes[idx];
          modalSizes[idx] = tmp2;
        }
        renderModalChips();
      };

      $("addColorBtn").onclick = function () {
        var v = $("modalColorInput").value.replace(/\s+$/, "");
        if (!v) return;
        if (modalColors.indexOf(v) === -1) modalColors.push(v);
        $("modalColorInput").value = "";
        renderModalChips();
      };
      $("modalColorInput").onkeypress = function (e) {
        if ((e.key || e.which) === "Enter" || e.which === 13) {
          $("addColorBtn").onclick();
          e.preventDefault();
        }
      };

      $("addSizeBtn").onclick = function () {
        var v = $("modalSizeInput").value.replace(/\s+$/, "");
        if (!v) return;
        if (modalSizes.indexOf(v) === -1) modalSizes.push(v);
        $("modalSizeInput").value = "";
        renderModalChips();
      };
      $("modalSizeInput").onkeypress = function (e) {
        if ((e.key || e.which) === "Enter" || e.which === 13) {
          $("addSizeBtn").onclick();
          e.preventDefault();
        }
      };

      function renderModalImagePreview() {
        var box = $("modalImagePreview");
        box.innerHTML = "";
        if (modalImageDataUrl) {
          var img = document.createElement("img");
          img.src = modalImageDataUrl;
          box.appendChild(img);
        } else {
          box.innerHTML = "<span>Tap to upload</span>";
        }
      }

      $("modalImageFile").onchange = function () {
        var file =
          this && this.files && this.files[0] ? this.files[0] : null;
        if (!file) return;
        var reader = new FileReader();
        reader.onload = function (e) {
          modalImageDataUrl = e.target.result;
          renderModalImagePreview();
        };
        reader.readAsDataURL(file);
      };

      $("modalImagePreview").onclick = function () {
        $("modalImageFile").click();
      };

      $("modalCloseBtn").onclick = closeStyleModal;
      $("modalCancelBtn").onclick = closeStyleModal;

      $("modalSaveBtn").onclick = function () {
        var name = $("modalStyleName").value.replace(/\s+$/, "");
        var code = $("modalStyleCode").value.replace(/\s+$/, "");
        var price = $("modalPrice").value;
        var desc = $("modalDescription").value;
        var cat = $("modalCategory").value;
        var inStock = $("modalInStock").checked;

        if (!name && !code) {
          alert("Enter at least a style name or style code.");
          return;
        }
        if (!modalColors.length) {
          alert("Add at least one color.");
          return;
        }
        if (!modalSizes.length) {
          alert("Add at least one size.");
          return;
        }

        var newKey = styleKeyFromParts(code, name);

        var newCatalog = [];
        var i;
        for (i = 0; i < catalog.length; i++) {
          var row = catalog[i];
          var rKey = styleKeyFromParts(
            row.style_code || "",
            row.style_name || ""
          );
          if (editingStyleKey && rKey === editingStyleKey) {
            continue;
          }
          newCatalog.push(row);
        }

        for (var c = 0; c < modalColors.length; c++) {
          for (var s = 0; s < modalSizes.length; s++) {
            newCatalog.push({
              style_code: code,
              style_name: name,
              color: modalColors[c],
              size: modalSizes[s],
              price: price || "",
            });
          }
        }

        catalog = newCatalog;
        saveCatalog(catalog);
        saveStyleMetaEntry(
          newKey,
          desc,
          cat,
          inStock,
          modalImageDataUrl,
          modalSizes
        );

        renderProductsGrid();
        renderStylesGrid();
        updateDashboard();
        closeStyleModal();
        alert("Style saved.");
      };

      function saveStyleMetaEntry(
        key,
        desc,
        cat,
        inStock,
        imageDataUrl,
        sizeOrder
      ) {
        if (!key) return;
        if (!styleMeta[key]) styleMeta[key] = {};
        styleMeta[key].description = desc || "";
        styleMeta[key].category = cat || "";
        styleMeta[key].in_stock = !!inStock;
        if (imageDataUrl) styleMeta[key].imageDataUrl = imageDataUrl;
        if (sizeOrder && sizeOrder.length)
          styleMeta[key].sizeOrder = sizeOrder.slice();
        saveStyleMeta();
      }

      $("addStyleBtn").onclick = function () {
        openStyleModal(null, false);
      };

      $("productsGrid").onclick = function (e) {
        var t = e.target || e.srcElement;
        if (t.tagName.toLowerCase() !== "button") return;
        var key = t.getAttribute("data-style-key");
        var action = t.getAttribute("data-action");
        if (!key || !action) return;

        if (action === "edit") {
          openStyleModal(key, false);
        } else if (action === "duplicate") {
          openStyleModal(key, true);
        } else if (action === "delete") {
          if (!confirm("Delete this style from catalog?")) return;
          var newCatalog = [];
          for (var i = 0; i < catalog.length; i++) {
            var row = catalog[i];
            var rKey = styleKeyFromParts(
              row.style_code || "",
              row.style_name || ""
            );
            if (rKey === key) continue;
            newCatalog.push(row);
          }
          catalog = newCatalog;
          saveCatalog(catalog);
          delete styleMeta[key];
          saveStyleMeta();
          renderProductsGrid();
          renderStylesGrid();
          updateDashboard();
        }
      };

      // CSV import / export for catalog
      $("importCatalog").onclick = function () {
        var fileInput = $("catalogFile");
        var file =
          fileInput && fileInput.files && fileInput.files[0]
            ? fileInput.files[0]
            : null;
        if (!file) {
          alert("Choose a CSV file first.");
          return;
        }
        var reader = new FileReader();
        reader.onload = function (e) {
          var text = e.target.result;
          var rows = parseCsv(text);
          if (!rows.length) {
            alert("No rows in CSV.");
            return;
          }
          var first = rows[0];
          var req = [
            "style_code",
            "style_name",
            "color",
            "size",
          ];
          var missing = [];
          for (var i = 0; i < req.length; i++) {
            if (!first.hasOwnProperty(req[i])) missing.push(req[i]);
          }
          if (missing.length) {
            alert(
              "Missing columns: " +
                missing.join(", ") +
                ". CSV must have style_code, style_name, color, size."
            );
            return;
          }
          catalog = [];
          for (var j = 0; j < rows.length; j++) {
            catalog.push({
              style_code: rows[j].style_code || "",
              style_name: rows[j].style_name || "",
              color: rows[j].color || "",
              size: rows[j].size || "",
              price: rows[j].price || "",
            });
          }
          saveCatalog(catalog);
          renderProductsGrid();
          renderStylesGrid();
          updateDashboard();
          alert("Catalog imported.");
        };
        reader.readAsText(file);
      };

      $("exportCatalog").onclick = function () {
        if (!catalog.length) {
          alert("No catalog to export.");
          return;
        }
        var headers = [
          "style_code",
          "style_name",
          "color",
          "size",
          "price",
        ];
        var rows = [headers];
        for (var i = 0; i < catalog.length; i++) {
          var r = catalog[i];
          rows.push([
            r.style_code || "",
            r.style_name || "",
            r.color || "",
            r.size || "",
            r.price || "",
          ]);
        }
        var lines = [];
        for (var rowIdx = 0; rowIdx < rows.length; rowIdx++) {
          var row = rows[rowIdx];
          for (var c = 0; c < row.length; c++) {
            row[c] = '"' + String(row[c]).replace(/"/g, '""') + '"';
          }
          lines.push(row.join(","));
        }
        var csv = lines.join("\n");
        var blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        var url = URL.createObjectURL(blob);
        var a = document.createElement("a");
        a.href = url;
        a.download =
          "blanco_catalog_" +
          new Date().toISOString().slice(0, 10) +
          ".csv";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };

      function parseCsv(text) {
        var lines = text.split(/\r?\n/);
        var out = [];
        if (!lines.length) return out;
        var header = lines[0].split(",");
        var i;
        for (i = 0; i < header.length; i++) {
          header[i] = header[i].trim().toLowerCase();
        }
        for (var r = 1; r < lines.length; r++) {
          var line = lines[r];
          if (!line) continue;
          var cols = line.split(",");
          var obj = {};
          for (var c = 0; c < header.length; c++) {
            obj[header[c]] = (cols[c] || "").replace(/^"|"$/g, "");
          }
          out.push(obj);
        }
        return out;
      }

      var signatureCanvasEl = $("signatureCanvas");
      if (signatureCanvasEl) {
        signatureCanvasEl.addEventListener("pointerdown", startSignatureDraw);
        signatureCanvasEl.addEventListener("pointermove", continueSignatureDraw);
        signatureCanvasEl.addEventListener("pointerup", endSignatureDraw);
        signatureCanvasEl.addEventListener("pointerleave", endSignatureDraw);
        attachSignatureTouchBlockers();
      }

      if ($("signatureSaveBtn")) $("signatureSaveBtn").onclick = saveSignature;
      if ($("signatureClearBtn"))
        $("signatureClearBtn").onclick = clearSignatureCanvas;
      if ($("signatureEditBtn"))
        $("signatureEditBtn").onclick = function () {
          if (!signatureCurrentTs) return;
          if (signatureMode === "view") {
            signatureMode = "edit";
            signatureHasDrawing = false;
            resizeSignatureCanvas();
            clearSignatureCanvas();
          } else {
            var existingSig = getActiveSignature();
            if (existingSig) {
              signatureMode = "view";
              signatureHasDrawing = false;
            }
          }
          renderSignatureSection();
        };

      window.addEventListener("resize", function () {
        if (signatureMode === "edit") resizeSignatureCanvas();
      });

      // ---------- INIT ----------
      (function init() {
        catalog = getCatalog();
        loadStyleMeta();
        loadEmailOpts();
        if ($("emailToggleTotalQty"))
          $("emailToggleTotalQty").onclick = function () {
            toggleButton("emailToggleTotalQty");
            saveEmailOptsFromUI();
          };
        if ($("emailToggleTotals"))
          $("emailToggleTotals").onclick = function () {
            toggleButton("emailToggleTotals");
            saveEmailOptsFromUI();
          };
        if ($("emailUseTaxAmount"))
          $("emailUseTaxAmount").onclick = function () {
            toggleButton("emailUseTaxAmount");
            saveEmailOptsFromUI();
          };
        if ($("emailUseShippingAmount"))
          $("emailUseShippingAmount").onclick = function () {
            toggleButton("emailUseShippingAmount");
            saveEmailOptsFromUI();
          };
        if ($("emailTaxAmount"))
          $("emailTaxAmount").oninput = saveEmailOptsFromUI;
        if ($("emailShippingAmount"))
          $("emailShippingAmount").oninput = saveEmailOptsFromUI;
        if ($("emailIncludeNotes"))
          $("emailIncludeNotes").onchange =
            saveEmailOptsFromUI;
        if ($("emailIncludeUnitPrice"))
          $("emailIncludeUnitPrice").onchange =
            saveEmailOptsFromUI;
        if ($("emailSubjectPrefix"))
          $("emailSubjectPrefix").oninput = saveEmailOptsFromUI;
        if ($("emailHeadingLine"))
          $("emailHeadingLine").oninput = saveEmailOptsFromUI;
        if ($("emailIntroMessage"))
          $("emailIntroMessage").oninput = saveEmailOptsFromUI;
        if ($("emailFooterLine"))
          $("emailFooterLine").oninput = saveEmailOptsFromUI;
        renderProductsGrid();
        renderStylesGrid();
        updateDashboard();
        renderOrders();
      })();
    </script>
  </body>
</html>
