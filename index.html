<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <title>BLANCO Clothing – Offline OrderFlow</title>

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="apple-mobile-web-app-title" content="BLANCO Clothing" />
    <link rel="apple-touch-icon" href="/icons/icon-192.png" />

    <style>
      :root {
        color-scheme: light;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        background: #f5f5f7;
        color: #111827;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        padding: 16px;
      }
      .app {
        width: 100%;
        max-width: 1100px;
        background: #ffffff;
        border-radius: 16px;
        padding: 12px 18px 18px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
        position: relative;
        overflow: hidden;
      }

      /* Top bar + menu */
      .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }
      .menu-button {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border-radius: 999px;
        padding: 6px 10px;
        border: 1px solid #e5e7eb;
        background: #111827;
        color: #f9fafb;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        cursor: pointer;
      }
      .menu-icon {
        width: 14px;
        height: 2px;
        background: #f9fafb;
        position: relative;
      }
      .menu-icon::before,
      .menu-icon::after {
        content: "";
        position: absolute;
        left: 0;
        width: 14px;
        height: 2px;
        background: #f9fafb;
      }
      .menu-icon::before {
        top: -4px;
      }
      .menu-icon::after {
        top: 4px;
      }
      .top-brand {
        text-align: right;
        font-size: 11px;
        color: #6b7280;
      }
      .top-brand span {
        display: block;
      }

      /* slide-down menu */
      .menu-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        background: rgba(15, 23, 42, 0.96);
        color: #f9fafb;
        transform: translateY(-100%);
        transition: transform 0.18s ease-out;
        z-index: 20;
      }
      .menu-overlay.open {
        transform: translateY(0);
      }
      .menu-panel {
        padding: 12px 18px 12px;
      }
      .menu-header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
      }
      .menu-title {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #d1d5db;
      }
      .menu-close {
        border-radius: 999px;
        padding: 4px 10px;
        border: 1px solid #374151;
        background: transparent;
        color: #e5e7eb;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        cursor: pointer;
      }
      .menu-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .menu-item {
        padding: 7px 0;
        font-size: 13px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .menu-item span.bullet {
        width: 7px;
        height: 7px;
        border-radius: 999px;
        border: 1px solid #6b7280;
      }
      .menu-item-primary {
        font-weight: 600;
      }
      .menu-item:hover {
        color: #ffffff;
      }

      header {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        align-items: baseline;
        margin-bottom: 12px;
        border-bottom: 1px solid #e5e7eb;
        padding-bottom: 8px;
      }
      header h1 {
        font-size: 20px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        margin: 0;
        color: #111827;
      }
      header span {
        font-size: 12px;
        color: #6b7280;
      }

      .views {
        margin-top: 4px;
      }
      .view {
        display: none;
      }
      .view.active {
        display: block;
      }

      h2 {
        font-size: 16px;
        margin: 0 0 6px;
      }

      .subtext {
        font-size: 12px;
        color: #6b7280;
        margin-bottom: 10px;
      }

      section.card {
        background: #ffffff;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        padding: 12px;
        margin-bottom: 12px;
      }

      .grid-two {
        display: grid;
        grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
        gap: 12px;
      }
      @media (max-width: 800px) {
        .grid-two {
          grid-template-columns: minmax(0, 1fr);
        }
      }

      label {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #6b7280;
        display: block;
        margin-bottom: 4px;
      }
      input,
      textarea,
      select {
        width: 100%;
        padding: 7px 9px;
        border-radius: 8px;
        border: 1px solid #d1d5db;
        background: #ffffff;
        color: #111827;
        font-size: 13px;
      }
      input:focus,
      textarea:focus,
      select:focus {
        outline: none;
        border-color: #111827;
      }
      textarea {
        resize: vertical;
        min-height: 60px;
      }
      .field-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
        margin-bottom: 8px;
      }
      .field-full {
        margin-bottom: 8px;
      }

      button {
        border-radius: 999px;
        padding: 7px 14px;
        border: 1px solid #111827;
        background: #111827;
        color: #f9fafb;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        cursor: pointer;
      }
      button.secondary {
        background: #ffffff;
        color: #111827;
        border-color: #d1d5db;
      }
      button.danger {
        background: #ef4444;
        border-color: #ef4444;
        color: #ffffff;
      }
      button.small {
        font-size: 11px;
        padding: 4px 10px;
      }
      button:active {
        transform: translateY(1px);
      }
      .actions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: flex-end;
        margin-top: 8px;
      }

      .pill {
        border-radius: 999px;
        padding: 2px 10px;
        font-size: 11px;
        background: #f3f4f6;
        color: #111827;
        border: 1px solid #e5e7eb;
      }
      .hint {
        font-size: 11px;
        color: #6b7280;
        margin-top: 4px;
      }

      /* Dashboard */
      .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 10px;
      }
      .stat-card {
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        padding: 10px;
        background: #f9fafb;
      }
      .stat-label {
        font-size: 11px;
        color: #6b7280;
        margin-bottom: 4px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }
      .stat-value {
        font-size: 18px;
        font-weight: 600;
      }

      /* Styles grid */
      .styles-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
      }
      .style-card {
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        background: #ffffff;
        padding: 10px;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        gap: 6px;
        transition: box-shadow 0.15s, border-color 0.15s, transform 0.1s;
      }
      .style-card:hover {
        border-color: #111827;
        box-shadow: 0 8px 20px rgba(15, 23, 42, 0.06);
        transform: translateY(-1px);
      }
      .style-card.selected {
        border-color: #111827;
        box-shadow: 0 8px 20px rgba(15, 23, 42, 0.12);
      }
      .style-header {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .style-thumb {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        background: #f3f4f6;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        color: #9ca3af;
      }
      .style-meta {
        flex: 1;
      }
      .style-name {
        font-size: 13px;
        font-weight: 600;
      }
      .style-code {
        font-size: 11px;
        color: #6b7280;
      }
      .style-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 11px;
        color: #6b7280;
        margin-top: 4px;
      }
      .checkmark {
        width: 18px;
        height: 18px;
        border-radius: 999px;
        border: 2px solid #d1d5db;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        color: #111827;
      }
      .style-card.selected .checkmark {
        border-color: #111827;
        background: #111827;
        color: #f9fafb;
        content: "✓";
      }

      /* Stepper */
      .stepper {
        display: flex;
        gap: 8px;
        align-items: center;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        margin-bottom: 8px;
      }
      .step-pill {
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid #e5e7eb;
        background: #f9fafb;
        color: #6b7280;
      }
      .step-pill.active {
        background: #111827;
        border-color: #111827;
        color: #f9fafb;
      }

      /* Color selection cards */
      .color-style-card {
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        background: #f9fafb;
        margin-bottom: 10px;
      }
      .color-style-header {
        padding: 10px;
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .color-style-body {
        padding: 10px;
        border-top: 1px solid #e5e7eb;
      }
      .color-row {
        display: grid;
        grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
        gap: 8px;
      }
      @media (max-width: 640px) {
        .color-row {
          grid-template-columns: minmax(0, 1fr);
        }
      }
      .color-chip {
        display: flex;
        align-items: center;
        gap: 6px;
        border-radius: 999px;
        border: 1px solid #e5e7eb;
        padding: 6px 10px;
        background: #ffffff;
        cursor: pointer;
        font-size: 13px;
      }
      .color-checkbox {
        width: 14px;
        height: 14px;
        border-radius: 4px;
        border: 1px solid #d1d5db;
        background: #ffffff;
      }
      .color-chip.selected {
        border-color: #111827;
        background: #111827;
        color: #f9fafb;
      }

      /* Size qty cards */
      .qty-card {
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        background: #f9fafb;
        margin-bottom: 10px;
        padding: 10px;
      }
      .qty-header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: 6px;
      }
      .qty-header-title {
        font-size: 13px;
        font-weight: 600;
      }
      .qty-header-sub {
        font-size: 11px;
        color: #6b7280;
      }
      .sizes-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: 8px;
        margin-top: 6px;
      }
      .size-chip {
        background: #ffffff;
        border-radius: 8px;
        padding: 6px 8px;
        border: 1px solid #e5e7eb;
        font-size: 12px;
      }
      .size-chip label {
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #6b7280;
        margin-bottom: 2px;
      }

      /* Orders table */
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 11px;
      }
      th,
      td {
        padding: 6px 4px;
        border-bottom: 1px solid #e5e7eb;
        text-align: left;
      }
      th {
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #6b7280;
        font-weight: 500;
      }
      tr:last-child td {
        border-bottom: none;
      }
      .empty {
        font-size: 12px;
        color: #9ca3af;
        text-align: center;
        padding: 18px 0;
      }

      /* Products table */
      .catalog-table-wrapper {
        margin-top: 8px;
        max-height: 260px;
        overflow: auto;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
      }
      .catalog-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 11px;
      }
      .catalog-table th,
      .catalog-table td {
        padding: 4px 6px;
        border-bottom: 1px solid #e5e7eb;
      }
      .catalog-table input {
        font-size: 11px;
        padding: 3px 4px;
        width: 100%;
      }

      @media (max-width: 600px) {
        body {
          padding: 10px;
        }
        .app {
          padding: 10px 12px 14px;
        }
        header {
          flex-direction: column;
          align-items: flex-start;
        }
      }
    </style>
  </head>

  <body>
    <div class="app">
      <!-- MENU -->
      <div id="menuOverlay" class="menu-overlay">
        <div class="menu-panel">
          <div class="menu-header-row">
            <div class="menu-title">BLANCO Menu</div>
            <button type="button" id="menuClose" class="menu-close">
              Close
            </button>
          </div>
          <ul class="menu-list">
            <li class="menu-item" data-view="dashboard-view">
              <span class="bullet"></span>
              Dashboard
            </li>
            <li
              class="menu-item menu-item-primary"
              data-view="order-view"
            >
              <span class="bullet"></span>
              + Order
            </li>
            <li class="menu-item" data-view="orders-view">
              <span class="bullet"></span>
              Orders
            </li>
            <li class="menu-item" data-view="products-view">
              <span class="bullet"></span>
              Products
            </li>
          </ul>
        </div>
      </div>

      <!-- TOP BAR -->
      <div class="top-bar">
        <button type="button" id="menuButton" class="menu-button">
          <span class="menu-icon"></span>
          Menu
        </button>
        <div class="top-brand">
          <span>BLANCO / Offline OrderFlow</span>
          <span id="topTimestamp"></span>
        </div>
      </div>

      <header>
        <div>
          <h1>BLANCO Clothing</h1>
          <span id="viewTitle">Dashboard</span>
        </div>
        <span id="last-sync">No orders yet</span>
      </header>

      <div class="views">
        <!-- DASHBOARD -->
        <div id="dashboard-view" class="view active">
          <section class="card">
            <h2>Snapshot</h2>
            <p class="subtext">
              Quick overview of offline activity on this device.
            </p>
            <div class="stats-row">
              <div class="stat-card">
                <div class="stat-label">Offline orders</div>
                <div id="stat-orders" class="stat-value">0</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Styles in catalog</div>
                <div id="stat-styles" class="stat-value">0</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Last activity</div>
                <div id="stat-last" class="stat-value" style="font-size:13px">
                  —
                </div>
              </div>
            </div>
            <div class="actions" style="justify-content:flex-start;margin-top:12px;">
              <button type="button" id="quickNewOrder">+ New order</button>
              <button
                type="button"
                id="quickViewOrders"
                class="secondary small"
              >
                View orders
              </button>
              <button
                type="button"
                id="quickViewProducts"
                class="secondary small"
              >
                Manage products
              </button>
            </div>
          </section>
        </div>

        <!-- ORDER FLOW -->
        <div id="order-view" class="view">
          <section class="card">
            <div class="stepper">
              <span id="step1-pill" class="step-pill active">1. Styles</span>
              <span>›</span>
              <span id="step2-pill" class="step-pill">2. Colors</span>
              <span>›</span>
              <span id="step3-pill" class="step-pill">3. Sizes & Qty</span>
            </div>

            <!-- customer info -->
            <div class="field-row" style="margin-bottom:10px;">
              <div>
                <label for="customerName">Customer</label>
                <input
                  id="customerName"
                  placeholder="Customer name"
                  autocomplete="off"
                />
              </div>
              <div>
                <label for="customerEmail">Email</label>
                <input
                  id="customerEmail"
                  type="email"
                  placeholder="customer@email.com"
                  autocomplete="off"
                />
              </div>
              <div>
                <label for="customerPhone">Phone</label>
                <input
                  id="customerPhone"
                  placeholder="+1 (555) 123-4567"
                  autocomplete="off"
                />
              </div>
            </div>

            <!-- STEP 1 -->
            <div id="order-step-1">
              <h2>Select Styles</h2>
              <p class="subtext">
                Tap one or more styles to include in this order. Styles come
                from your Products catalog.
              </p>
              <div class="field-full" style="margin-bottom:8px;">
                <label for="styleSearch">Search styles</label>
                <input
                  id="styleSearch"
                  placeholder="Search by style code or name"
                />
              </div>
              <div id="stylesGrid" class="styles-grid"></div>
              <div class="hint" id="stylesEmptyHint">
                No styles found. Add products in the Products tab.
              </div>

              <div class="actions">
                <button
                  type="button"
                  id="step1-next"
                  class="secondary"
                >
                  Continue to colors ›
                </button>
              </div>
            </div>

            <!-- STEP 2 -->
            <div id="order-step-2" style="display:none;">
              <h2>Step 2: Choose Colors</h2>
              <p class="subtext">
                For each selected style, choose one or more colors to include.
              </p>
              <div id="colorsContainer"></div>
              <div class="actions" style="justify-content:space-between;">
                <button
                  type="button"
                  id="step2-back"
                  class="secondary"
                >
                  ‹ Back to styles
                </button>
                <button type="button" id="step2-next">
                  Continue to sizes & quantities ›
                </button>
              </div>
            </div>

            <!-- STEP 3 -->
            <div id="order-step-3" style="display:none;">
              <h2>Step 3: Sizes & Quantities</h2>
              <p class="subtext">
                Enter quantities for each style, color, and size. You can leave
                sizes at 0 if not needed.
              </p>
              <div id="qtyContainer"></div>

              <div class="field-full" style="margin-top:6px;">
                <label for="notes">Order notes</label>
                <textarea
                  id="notes"
                  placeholder="Fit notes, ship window, wholesale vs DTC, etc."
                ></textarea>
              </div>

              <div class="actions" style="justify-content:space-between;">
                <button
                  type="button"
                  id="step3-back"
                  class="secondary"
                >
                  ‹ Back to colors
                </button>
                <div style="display:flex;gap:8px;">
                  <button
                    type="button"
                    id="clear-order"
                    class="secondary small"
                  >
                    Clear
                  </button>
                  <button type="button" id="save-order">
                    Save offline order
                  </button>
                </div>
              </div>
            </div>
          </section>
        </div>

        <!-- ORDERS VIEW -->
        <div id="orders-view" class="view">
          <section class="card">
            <h2>Orders</h2>
            <p class="subtext">
              Orders are stored only on this device. Export to CSV for Excel.
            </p>

            <div class="actions" style="justify-content:flex-start;">
              <button
                type="button"
                id="export-csv"
                class="secondary small"
              >
                Export all orders CSV
              </button>
              <button
                type="button"
                id="clear-orders"
                class="danger small"
              >
                Clear all
              </button>
            </div>

            <div id="orders-empty" class="empty">
              No orders yet. Place an order from the + Order tab.
            </div>
            <table id="orders-table" style="display:none;margin-top:6px;">
              <thead>
                <tr>
                  <th>Time</th>
                  <th>Customer</th>
                  <th>Style</th>
                  <th>Color</th>
                  <th>Size</th>
                  <th>Qty</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="orders-tbody"></tbody>
            </table>
          </section>
        </div>

        <!-- PRODUCTS VIEW -->
        <div id="products-view" class="view">
          <section class="card">
            <h2>Products</h2>
            <p class="subtext">
              Upload and edit your product catalog. The + Order flow uses this
              data to know styles, colors, and sizes.
            </p>

            <div class="field-full">
              <label for="productFile">Upload product CSV</label>
              <input id="productFile" type="file" accept=".csv" />
              <div class="hint">
                Excel → Save As → <strong>CSV (Comma delimited)</strong>.
                Required headers:
                <code>style_code, style_name, color, size</code> (extra columns
                like <code>price</code> are optional).
              </div>
            </div>

            <div class="actions" style="justify-content:flex-start;">
              <button
                type="button"
                id="import-products"
                class="secondary small"
              >
                Import / replace catalog
              </button>
              <button
                type="button"
                id="export-products"
                class="secondary small"
              >
                Export catalog CSV
              </button>
              <button
                type="button"
                id="add-catalog-row"
                class="small"
              >
                Add row
              </button>
              <button
                type="button"
                id="save-catalog"
                class="small"
              >
                Save changes
              </button>
            </div>

            <div class="subtext" id="catalog-summary">
              No products loaded.
            </div>
            <div
              class="subtext"
              id="catalog-updated"
              style="margin-top:2px;"
            ></div>

            <div class="catalog-table-wrapper">
              <table class="catalog-table">
                <thead>
                  <tr>
                    <th>Style code</th>
                    <th>Style name</th>
                    <th>Color</th>
                    <th>Size</th>
                    <th>Price (opt)</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="catalog-tbody"></tbody>
              </table>
            </div>
          </section>
        </div>
      </div>
    </div>

    <script>
      const ORDERS_KEY = "blanco_offline_orders_stepflow_v1";
      const CATALOG_KEY = "blanco_product_catalog_v2";

      // STATE FOR ORDER FLOW
      let catalogCache = [];
      let styleIndex = new Map(); // styleKey -> {code,name,colors:Set,sizesByColor:Map,price}
      let selectedStyles = new Set(); // styleKey
      let selectedColorsByStyle = new Map(); // styleKey -> Set(colors)

      // DOM helpers
      const $ = (id) => document.getElementById(id);

      const menuButton = $("menuButton");
      const menuOverlay = $("menuOverlay");
      const menuClose = $("menuClose");
      const viewTitle = $("viewTitle");
      const topTimestamp = $("topTimestamp");
      const lastSync = $("last-sync");

      function updateTimestamp() {
        const now = new Date();
        topTimestamp.textContent = now.toLocaleString();
      }
      updateTimestamp();
      setInterval(updateTimestamp, 60000);

      // STORAGE HELPERS
      function getOrders() {
        try {
          const raw = localStorage.getItem(ORDERS_KEY);
          return raw ? JSON.parse(raw) : [];
        } catch {
          return [];
        }
      }
      function saveOrders(orders) {
        localStorage.setItem(ORDERS_KEY, JSON.stringify(orders));
        if (orders.length) {
          const last = orders[orders.length - 1];
          lastSync.textContent =
            "Last order: " + new Date(last.createdAt).toLocaleString();
        } else {
          lastSync.textContent = "No orders yet";
        }
        updateDashboardStats();
      }
      function getCatalog() {
        try {
          const raw = localStorage.getItem(CATALOG_KEY);
          return raw ? JSON.parse(raw) : [];
        } catch {
          return [];
        }
      }
      function saveCatalogData(list) {
        localStorage.setItem(CATALOG_KEY, JSON.stringify(list));
        catalogCache = list;
        buildStyleIndex();
        updateCatalogSummary();
        renderCatalogTable();
        renderStylesGrid();
        updateDashboardStats();
      }

      // DASHBOARD
      function updateDashboardStats() {
        const orders = getOrders();
        const uniqueStyles = new Set(
          catalogCache.map((r) => (r.style_code || "").trim())
        );
        $("stat-orders").textContent = orders.length;
        $("stat-styles").textContent = uniqueStyles.size;
        $("stat-last").textContent =
          orders.length === 0
            ? "—"
            : new Date(
                orders[orders.length - 1].createdAt
              ).toLocaleString();
      }

      // VIEWS
      function setView(viewId) {
        document
          .querySelectorAll(".view")
          .forEach((v) => v.classList.remove("active"));
        $(viewId).classList.add("active");

        switch (viewId) {
          case "dashboard-view":
            viewTitle.textContent = "Dashboard";
            break;
          case "order-view":
            viewTitle.textContent = "+ Order";
            resetOrderFlow();
            break;
          case "orders-view":
            viewTitle.textContent = "Orders";
            renderOrders();
            break;
          case "products-view":
            viewTitle.textContent = "Products";
            break;
        }
      }

      // MENU EVENTS
      menuButton.addEventListener("click", () =>
        menuOverlay.classList.add("open")
      );
      menuClose.addEventListener("click", () =>
        menuOverlay.classList.remove("open")
      );
      menuOverlay.addEventListener("click", (e) => {
        if (e.target === menuOverlay) menuOverlay.classList.remove("open");
      });
      menuOverlay
        .querySelector(".menu-list")
        .addEventListener("click", (e) => {
          const item = e.target.closest(".menu-item");
          if (!item) return;
          const view = item.dataset.view;
          if (view) {
            setView(view);
          }
          menuOverlay.classList.remove("open");
        });

      // QUICK ACTIONS
      $("quickNewOrder").addEventListener("click", () =>
        setView("order-view")
      );
      $("quickViewOrders").addEventListener("click", () =>
        setView("orders-view")
      );
      $("quickViewProducts").addEventListener("click", () =>
        setView("products-view")
      );

      // BUILD STYLE INDEX FROM CATALOG
      function buildStyleIndex() {
        styleIndex = new Map();
        const list = catalogCache;
        for (const row of list) {
          const code = (row.style_code || "").trim();
          const name = (row.style_name || "").trim();
          const styleKey = code || name;
          if (!styleKey) continue;
          const color = (row.color || "").trim();
          const size = (row.size || "").trim();
          const price = row.price || "";

          if (!styleIndex.has(styleKey)) {
            styleIndex.set(styleKey, {
              styleKey,
              code,
              name,
              colors: new Set(),
              sizesByColor: new Map(),
              price,
            });
          }
          const meta = styleIndex.get(styleKey);
          if (color) {
            meta.colors.add(color);
            if (!meta.sizesByColor.has(color)) {
              meta.sizesByColor.set(color, new Set());
            }
            if (size) meta.sizesByColor.get(color).add(size);
          }
          if (price && !meta.price) meta.price = price;
        }
      }

      // STYLES GRID (STEP 1)
      function renderStylesGrid() {
        const grid = $("stylesGrid");
        const hint = $("stylesEmptyHint");
        grid.innerHTML = "";

        const search = $("styleSearch").value.trim().toLowerCase();

        const entries = Array.from(styleIndex.values());
        const filtered = entries.filter((s) => {
          if (!search) return true;
          return (
            (s.code || "").toLowerCase().includes(search) ||
            (s.name || "").toLowerCase().includes(search)
          );
        });

        if (!filtered.length) {
          hint.style.display = "block";
          return;
        }
        hint.style.display = "none";

        filtered.forEach((meta) => {
          const card = document.createElement("div");
          card.className = "style-card";
          if (selectedStyles.has(meta.styleKey)) {
            card.classList.add("selected");
          }
          card.dataset.styleKey = meta.styleKey;

          const header = document.createElement("div");
          header.className = "style-header";

          const thumb = document.createElement("div");
          thumb.className = "style-thumb";
          thumb.textContent = "◻︎";

          const metaDiv = document.createElement("div");
          metaDiv.className = "style-meta";

          const nameDiv = document.createElement("div");
          nameDiv.className = "style-name";
          nameDiv.textContent = meta.name || meta.code || "Unnamed style";

          const codeDiv = document.createElement("div");
          codeDiv.className = "style-code";
          codeDiv.textContent = meta.code || meta.name || "";

          metaDiv.appendChild(nameDiv);
          metaDiv.appendChild(codeDiv);

          const check = document.createElement("div");
          check.className = "checkmark";
          check.textContent = selectedStyles.has(meta.styleKey) ? "✓" : "";

          header.appendChild(thumb);
          header.appendChild(metaDiv);
          header.appendChild(check);

          const footer = document.createElement("div");
          footer.className = "style-footer";
          const colorsCount = meta.colors.size;
          let sizesCount = 0;
          meta.sizesByColor.forEach((set) => (sizesCount += set.size));
          footer.innerHTML = `
            <span>${colorsCount} colors • ${sizesCount} sizes</span>
            <span class="pill">${
              meta.price ? "$" + meta.price : "Price TBD"
            }</span>
          `;

          card.appendChild(header);
          card.appendChild(footer);

          card.addEventListener("click", () => {
            if (selectedStyles.has(meta.styleKey)) {
              selectedStyles.delete(meta.styleKey);
            } else {
              selectedStyles.add(meta.styleKey);
            }
            renderStylesGrid();
          });

          grid.appendChild(card);
        });
      }

      $("styleSearch").addEventListener("input", renderStylesGrid);

      // STEP CONTROL
      function setStep(step) {
        $("order-step-1").style.display =
          step === 1 ? "block" : "none";
        $("order-step-2").style.display =
          step === 2 ? "block" : "none";
        $("order-step-3").style.display =
          step === 3 ? "block" : "none";

        $("step1-pill").classList.toggle("active", step === 1);
        $("step2-pill").classList.toggle("active", step === 2);
        $("step3-pill").classList.toggle("active", step === 3);
      }

      // STEP 2 COLORS
      function renderColorSelection() {
        const container = $("colorsContainer");
        container.innerHTML = "";

        selectedColorsByStyle = selectedColorsByStyle || new Map();

        const selected = Array.from(selectedStyles).map((k) =>
          styleIndex.get(k)
        );
        if (!selected.length) {
          container.innerHTML =
            '<div class="hint">No styles selected. Go back to choose styles.</div>';
          return;
        }

        selected.forEach((meta) => {
          const card = document.createElement("div");
          card.className = "color-style-card";

          const header = document.createElement("div");
          header.className = "color-style-header";
          header.innerHTML = `
            <div class="style-thumb">◻︎</div>
            <div class="style-meta">
              <div class="style-name">${meta.name || meta.code}</div>
              <div class="style-code">${
                meta.code || meta.name || ""
              }</div>
              <div style="margin-top:4px;">
                <span class="pill">${
                  meta.price ? "$" + meta.price + " per piece" : "Price TBD"
                }</span>
              </div>
            </div>
          `;

          const body = document.createElement("div");
          body.className = "color-style-body";

          const colorRow = document.createElement("div");
          colorRow.className = "color-row";

          const selectedColors =
            selectedColorsByStyle.get(meta.styleKey) || new Set();

          Array.from(meta.colors)
            .sort()
            .forEach((color) => {
              const chip = document.createElement("div");
              chip.className = "color-chip";
              chip.dataset.styleKey = meta.styleKey;
              chip.dataset.color = color;
              if (selectedColors.has(color)) {
                chip.classList.add("selected");
              }

              const checkbox = document.createElement("div");
              checkbox.className = "color-checkbox";

              const label = document.createElement("span");
              label.textContent = color;

              chip.appendChild(checkbox);
              chip.appendChild(label);

              chip.addEventListener("click", () => {
                const set =
                  selectedColorsByStyle.get(meta.styleKey) ||
                  new Set();
                if (set.has(color)) {
                  set.delete(color);
                } else {
                  set.add(color);
                }
                if (set.size === 0) {
                  selectedColorsByStyle.delete(meta.styleKey);
                } else {
                  selectedColorsByStyle.set(meta.styleKey, set);
                }
                renderColorSelection();
              });

              colorRow.appendChild(chip);
            });

          body.innerHTML = "<label>Choose colors</label>";
          body.appendChild(colorRow);

          card.appendChild(header);
          card.appendChild(body);
          container.appendChild(card);
        });
      }

      // STEP 3 QTY
      function renderQtySelection() {
        const container = $("qtyContainer");
        container.innerHTML = "";

        const entries = [];
        selectedColorsByStyle.forEach((colorSet, styleKey) => {
          const meta = styleIndex.get(styleKey);
          if (!meta) return;
          colorSet.forEach((color) => {
            entries.push({ meta, color });
          });
        });

        if (!entries.length) {
          container.innerHTML =
            '<div class="hint">No colors selected. Go back to choose colors.</div>';
          return;
        }

        entries.forEach(({ meta, color }) => {
          const card = document.createElement("div");
          card.className = "qty-card";

          const header = document.createElement("div");
          header.className = "qty-header";
          header.innerHTML = `
            <div>
              <div class="qty-header-title">${meta.name || meta.code}</div>
              <div class="qty-header-sub">${
                meta.code || meta.name
              } • ${color}</div>
            </div>
            <div class="qty-header-sub">${
              meta.price ? "$" + meta.price + " per piece" : ""
            }</div>
          `;

          const sizesGrid = document.createElement("div");
          sizesGrid.className = "sizes-grid";

          const sizeSet = meta.sizesByColor.get(color) || new Set();
          const sizes = Array.from(sizeSet).sort((a, b) =>
            a.localeCompare(b, undefined, { numeric: true })
          );
          if (!sizes.length) {
            sizesGrid.innerHTML =
              '<div class="hint">No sizes defined for this color.</div>';
          } else {
            sizes.forEach((size) => {
              const chip = document.createElement("div");
              chip.className = "size-chip";
              const label = document.createElement("label");
              label.textContent = size;
              const input = document.createElement("input");
              input.type = "number";
              input.min = "0";
              input.step = "1";
              input.value = "";
              input.dataset.styleKey = meta.styleKey;
              input.dataset.color = color;
              input.dataset.size = size;

              chip.appendChild(label);
              chip.appendChild(input);
              sizesGrid.appendChild(chip);
            });
          }

          card.appendChild(header);
          card.appendChild(sizesGrid);
          container.appendChild(card);
        });
      }

      // SAVE ORDER
      function handleSaveOrder() {
        const catalog = catalogCache;
        if (!catalog.length) {
          alert(
            "No product catalog loaded.\n\nAdd products in the Products view first."
          );
          return;
        }

        const custName = $("customerName").value.trim();
        if (!custName) {
          alert("Customer is required.");
          return;
        }

        // Build lines from qty inputs
        const inputs = Array.from(
          $("qtyContainer").querySelectorAll("input[data-size]")
        );
        const lines = [];
        inputs.forEach((input) => {
          const qty = Number(input.value || 0);
          if (qty > 0) {
            lines.push({
              styleKey: input.dataset.styleKey,
              color: input.dataset.color,
              size: input.dataset.size,
              qty,
            });
          }
        });

        if (!lines.length) {
          alert("Enter quantity for at least one size.");
          return;
        }

        const orders = getOrders();
        const nowIso = new Date().toISOString();
        const notes = $("notes").value.trim();
        const email = $("customerEmail").value.trim();
        const phone = $("customerPhone").value.trim();

        lines.forEach((line) => {
          const meta = styleIndex.get(line.styleKey);
          let styleCode = "";
          let styleName = "";
          if (meta) {
            styleCode = meta.code;
            styleName = meta.name;
          }
          orders.push({
            createdAt: nowIso,
            customerName: custName,
            customerEmail: email,
            customerPhone: phone,
            styleCode,
            styleName,
            color: line.color,
            size: line.size,
            qty: line.qty,
            notes,
          });
        });

        saveOrders(orders);
        renderOrders();
        resetOrderFlow();
        alert("Order saved offline.");
      }

      function resetOrderFlow() {
        setStep(1);
        $("customerName").value = "";
        $("customerEmail").value = "";
        $("customerPhone").value = "";
        $("notes").value = "";
        selectedStyles = new Set();
        selectedColorsByStyle = new Map();
        $("styleSearch").value = "";
        renderStylesGrid();
        $("colorsContainer").innerHTML = "";
        $("qtyContainer").innerHTML = "";
      }

      // ORDERS RENDER
      function renderOrders() {
        const orders = getOrders();
        const table = $("orders-table");
        const tbody = $("orders-tbody");
        const empty = $("orders-empty");
        tbody.innerHTML = "";

        if (!orders.length) {
          table.style.display = "none";
          empty.style.display = "block";
          return;
        }
        table.style.display = "table";
        empty.style.display = "none";

        orders.forEach((o, idx) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${new Date(o.createdAt).toLocaleTimeString([], {
              hour: "2-digit",
              minute: "2-digit",
            })}</td>
            <td>${o.customerName || ""}</td>
            <td>${o.styleName || o.styleCode || ""}</td>
            <td>${o.color || ""}</td>
            <td>${o.size || ""}</td>
            <td>${o.qty || ""}</td>
            <td>
              <button type="button" class="secondary small" data-order-export="${idx}">
                Export
              </button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      }

      // ORDERS EXPORTS
      function exportOrdersCSV(orders, filename) {
        const headers = [
          "created_at",
          "customer_name",
          "customer_email",
          "customer_phone",
          "style_code",
          "style_name",
          "color",
          "size",
          "qty",
          "notes",
        ];
        const rows = orders.map((o) => [
          o.createdAt,
          o.customerName || "",
          o.customerEmail || "",
          o.customerPhone || "",
          o.styleCode || "",
          o.styleName || "",
          o.color || "",
          o.size || "",
          o.qty || "",
          (o.notes || "").replace(/\n/g, " "),
        ]);

        const csv = [headers, ...rows]
          .map((row) =>
            row
              .map((cell) => `"${String(cell).replace(/"/g, '""')}"`)
              .join(",")
          )
          .join("\n");

        const blob = new Blob([csv], {
          type: "text/csv;charset=utf-8;",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      $("export-csv").addEventListener("click", () => {
        const orders = getOrders();
        if (!orders.length) {
          alert("No orders to export.");
          return;
        }
        exportOrdersCSV(
          orders,
          "blanco_offline_orders_" +
            new Date().toISOString().slice(0, 10) +
            ".csv"
        );
      });

      $("orders-tbody").addEventListener("click", (e) => {
        const btn = e.target;
        const idx = btn.dataset && btn.dataset.orderExport;
        if (idx == null) return;
        const orders = getOrders();
        const o = orders[Number(idx)];
        if (!o) return;
        exportOrdersCSV(
          [o],
          "blanco_order_" +
            (o.customerName || "customer") +
            "_" +
            new Date(o.createdAt).toISOString().slice(0, 10) +
            ".csv"
        );
      });

      $("clear-orders").addEventListener("click", () => {
        if (
          !confirm(
            "Delete all saved orders on this device? This cannot be undone."
          )
        )
          return;
        localStorage.removeItem(ORDERS_KEY);
        renderOrders();
        lastSync.textContent = "No orders yet";
        updateDashboardStats();
      });

      // PRODUCTS (CATALOG) VIEW
      const productFileInput = $("productFile");
      const importProductsBtn = $("import-products");
      const exportProductsBtn = $("export-products");
      const catalogSummary = $("catalog-summary");
      const catalogUpdated = $("catalog-updated");
      const catalogTbody = $("catalog-tbody");

      function updateCatalogSummary() {
        const list = catalogCache;
        if (!list.length) {
          catalogSummary.textContent = "No products loaded.";
          catalogUpdated.textContent = "";
          return;
        }
        const styleSet = new Set(
          list.map((r) => (r.style_code || "").trim()).filter(Boolean)
        );
        catalogSummary.textContent =
          list.length + " rows • " + styleSet.size + " styles";
        const now = new Date();
        catalogUpdated.textContent =
          "Updated " +
          now.toLocaleDateString() +
          " " +
          now.toLocaleTimeString();
      }

      function renderCatalogTable() {
        catalogTbody.innerHTML = "";
        catalogCache.forEach((row, index) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><input data-field="style_code" data-index="${index}" value="${(row.style_code || "").replace(
              /"/g,
              "&quot;"
            )}"></td>
            <td><input data-field="style_name" data-index="${index}" value="${(row.style_name || "").replace(
              /"/g,
              "&quot;"
            )}"></td>
            <td><input data-field="color" data-index="${index}" value="${(row.color || "").replace(
              /"/g,
              "&quot;"
            )}"></td>
            <td><input data-field="size" data-index="${index}" value="${(row.size || "").replace(
              /"/g,
              "&quot;"
            )}"></td>
            <td><input data-field="price" data-index="${index}" value="${(row.price || "").replace(
              /"/g,
              "&quot;"
            )}"></td>
            <td>
              <button type="button" class="secondary small" data-dup="${index}">Dup</button>
              <button type="button" class="danger small" data-del="${index}">X</button>
            </td>
          `;
          catalogTbody.appendChild(tr);
        });
      }

      catalogTbody.addEventListener("input", (e) => {
        const input = e.target;
        const idx = input.dataset.index;
        const field = input.dataset.field;
        if (idx == null || !field) return;
        catalogCache[idx][field] = input.value;
        localStorage.setItem(CATALOG_KEY, JSON.stringify(catalogCache));
        buildStyleIndex();
        renderStylesGrid();
        updateCatalogSummary();
      });

      catalogTbody.addEventListener("click", (e) => {
        const btn = e.target;
        const delIdx = btn.dataset.del;
        const dupIdx = btn.dataset.dup;
        if (delIdx != null) {
          catalogCache.splice(Number(delIdx), 1);
          saveCatalogData(catalogCache);
        } else if (dupIdx != null) {
          const row = catalogCache[Number(dupIdx)];
          if (row) {
            catalogCache.splice(Number(dupIdx) + 1, 0, { ...row });
            saveCatalogData(catalogCache);
          }
        }
      });

      $("add-catalog-row").addEventListener("click", () => {
        catalogCache.push({
          style_code: "",
          style_name: "",
          color: "",
          size: "",
          price: "",
        });
        saveCatalogData(catalogCache);
      });

      $("save-catalog").addEventListener("click", () => {
        saveCatalogData(catalogCache);
        alert("Catalog saved on this device.");
      });

      // CSV PARSE/EXPORT
      function parseCsv(text) {
        const lines = text
          .split(/\r?\n/)
          .map((l) => l.trim())
          .filter((l) => l.length > 0);
        if (!lines.length) return [];
        const header = lines[0]
          .split(",")
          .map((h) => h.trim().toLowerCase());
        const rows = [];
        for (let i = 1; i < lines.length; i++) {
          const cols = lines[i].split(",");
          const obj = {};
          header.forEach((key, idx) => {
            obj[key] = (cols[idx] || "").trim();
          });
          rows.push(obj);
        }
        return rows;
      }

      importProductsBtn.addEventListener("click", () => {
        const file = productFileInput.files?.[0];
        if (!file) {
          alert("Choose a CSV file from Excel first.");
          return;
        }
        const reader = new FileReader();
        reader.onload = (e) => {
          const text = e.target.result;
          const rows = parseCsv(text);
          if (!rows.length) {
            alert("No data found in CSV.");
            return;
          }
          const first = rows[0];
          const required = ["style_code", "style_name", "color", "size"];
          const missing = required.filter((k) => !(k in first));
          if (missing.length) {
            alert(
              "Missing required columns: " +
                missing.join(", ") +
                "\n\nHeader row must include: style_code, style_name, color, size"
            );
            return;
          }
          const list = rows.map((r) => ({
            style_code: r.style_code || "",
            style_name: r.style_name || "",
            color: r.color || "",
            size: r.size || "",
            price: r.price || "",
          }));
          saveCatalogData(list);
          alert(
            "Imported " +
              list.length +
              " catalog rows. Styles in + Order updated."
          );
        };
        reader.readAsText(file);
      });

      exportProductsBtn.addEventListener("click", () => {
        if (!catalogCache.length) {
          alert("No catalog to export.");
          return;
        }
        const headers = [
          "style_code",
          "style_name",
          "color",
          "size",
          "price",
        ];
        const rows = catalogCache.map((r) => [
          r.style_code || "",
          r.style_name || "",
          r.color || "",
          r.size || "",
          r.price || "",
        ]);
        const csv = [headers, ...rows]
          .map((row) =>
            row
              .map((cell) => `"${String(cell).replace(/"/g, '""')}"`)
              .join(",")
          )
          .join("\n");
        const blob = new Blob([csv], {
          type: "text/csv;charset=utf-8;",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download =
          "blanco_catalog_" +
          new Date().toISOString().slice(0, 10) +
          ".csv";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });

      // STEP BUTTONS
      $("step1-next").addEventListener("click", () => {
        if (!selectedStyles.size) {
          alert("Select at least one style to continue.");
          return;
        }
        setStep(2);
        renderColorSelection();
      });
      $("step2-back").addEventListener("click", () => setStep(1));
      $("step2-next").addEventListener("click", () => {
        let any = false;
        selectedColorsByStyle.forEach((set) => {
          if (set.size) any = true;
        });
        if (!any) {
          alert("Select at least one color to continue.");
          return;
        }
        setStep(3);
        renderQtySelection();
      });
      $("step3-back").addEventListener("click", () => setStep(2));
      $("save-order").addEventListener("click", handleSaveOrder);
      $("clear-order").addEventListener("click", resetOrderFlow);

      // INITIALIZE
      (function init() {
        catalogCache = getCatalog();
        buildStyleIndex();
        renderStylesGrid();
        renderCatalogTable();
        updateCatalogSummary();
        const orders = getOrders();
        if (orders.length) {
          const last = orders[orders.length - 1];
          lastSync.textContent =
            "Last order: " +
            new Date(last.createdAt).toLocaleString();
        }
        renderOrders();
        updateDashboardStats();
      })();
    </script>
  </body>
</html>
