<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>BLANCO Offline Order App</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="apple-mobile-web-app-title" content="BLANCO Orders" />
    <link rel="apple-touch-icon" href="/icons/icon-192.png" />

    <style>
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        background: #f5f5f7;
        padding: 10px;
        display: flex;
        justify-content: center;
      }
      .app {
        width: 100%;
        max-width: 1100px;
        background: #ffffff;
        border-radius: 16px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
        padding: 12px 16px 16px;
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        border-bottom: 1px solid #e5e7eb;
        padding-bottom: 8px;
        margin-bottom: 8px;
      }
      header h1 {
        margin: 0;
        font-size: 20px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }
      header span {
        font-size: 11px;
        color: #6b7280;
      }

      /* NAV */
      .nav {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 10px;
      }
      .nav button {
        border-radius: 999px;
        padding: 6px 12px;
        border: 1px solid #d1d5db;
        background: #f9fafb;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        cursor: pointer;
      }
      .nav button.active {
        background: #111827;
        border-color: #111827;
        color: #f9fafb;
      }

      .view {
        display: none;
      }
      .view.active {
        display: block;
      }

      section.card {
        background: #ffffff;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        padding: 10px;
        margin-bottom: 10px;
      }

      h2 {
        margin: 0 0 4px;
        font-size: 16px;
      }
      .subtext {
        font-size: 12px;
        color: #6b7280;
        margin-bottom: 8px;
      }

      .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 8px;
      }
      .stat-card {
        background: #f9fafb;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        padding: 8px;
      }
      .stat-label {
        font-size: 11px;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        margin-bottom: 2px;
      }
      .stat-value {
        font-size: 18px;
        font-weight: 600;
      }

      label {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #6b7280;
        display: block;
        margin-bottom: 3px;
      }
      input,
      textarea,
      select {
        width: 100%;
        padding: 6px 8px;
        border-radius: 8px;
        border: 1px solid #d1d5db;
        font-size: 13px;
      }
      input:focus,
      textarea:focus,
      select:focus {
        outline: none;
        border-color: #111827;
      }
      textarea {
        resize: vertical;
        min-height: 60px;
      }
      .field-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 8px;
        margin-bottom: 8px;
      }
      .field-full {
        margin-bottom: 8px;
      }

      button {
        border-radius: 999px;
        padding: 6px 12px;
        border: 1px solid #111827;
        background: #111827;
        color: #f9fafb;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        cursor: pointer;
      }
      button.secondary {
        background: #ffffff;
        color: #111827;
        border-color: #d1d5db;
      }
      button.danger {
        background: #ef4444;
        border-color: #ef4444;
        color: #ffffff;
      }
      button.small {
        font-size: 11px;
        padding: 4px 9px;
      }
      .actions {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        justify-content: flex-end;
        margin-top: 8px;
      }

      .styles-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 8px;
      }
      .style-card {
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        padding: 8px;
        background: #ffffff;
        cursor: pointer;
      }
      .style-card.selected {
        border-color: #111827;
        box-shadow: 0 8px 20px rgba(15, 23, 42, 0.1);
      }
      .style-name {
        font-size: 13px;
        font-weight: 600;
      }
      .style-code {
        font-size: 11px;
        color: #6b7280;
      }
      .style-meta {
        font-size: 11px;
        color: #6b7280;
        margin-top: 4px;
      }

      .stepper {
        display: flex;
        gap: 6px;
        align-items: center;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        margin-bottom: 6px;
      }
      .step-pill {
        padding: 4px 8px;
        border-radius: 999px;
        border: 1px solid #e5e7eb;
        background: #f9fafb;
        color: #6b7280;
      }
      .step-pill.active {
        background: #111827;
        border-color: #111827;
        color: #f9fafb;
      }

      .color-card {
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        margin-bottom: 8px;
        background: #f9fafb;
      }
      .color-header {
        padding: 8px;
        border-bottom: 1px solid #e5e7eb;
      }
      .color-body {
        padding: 8px;
      }
      .color-list {
        display: grid;
        grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
        gap: 6px;
      }
      @media (max-width: 600px) {
        .color-list {
          grid-template-columns: minmax(0, 1fr);
        }
      }
      .color-chip {
        display: flex;
        align-items: center;
        gap: 6px;
        border-radius: 999px;
        border: 1px solid #e5e7eb;
        padding: 6px 10px;
        background: #ffffff;
        cursor: pointer;
        font-size: 13px;
      }
      .color-chip.selected {
        background: #111827;
        border-color: #111827;
        color: #f9fafb;
      }

      .qty-card {
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        margin-bottom: 8px;
        background: #f9fafb;
        padding: 8px;
      }
      .qty-header {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        margin-bottom: 4px;
      }
      .sizes-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: 6px;
      }
      .size-chip {
        background: #ffffff;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        padding: 4px 6px;
        font-size: 11px;
      }
      .size-chip label {
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #6b7280;
        margin-bottom: 2px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 11px;
      }
      th,
      td {
        border-bottom: 1px solid #e5e7eb;
        padding: 5px 4px;
        text-align: left;
      }
      th {
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #6b7280;
      }
      tr:last-child td {
        border-bottom: none;
      }
      .empty {
        font-size: 12px;
        text-align: center;
        color: #9ca3af;
        padding: 12px 0;
      }

      .catalog-table-wrapper {
        margin-top: 6px;
        max-height: 260px;
        overflow: auto;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
      }
      .catalog-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 11px;
      }
      .catalog-table th,
      .catalog-table td {
        padding: 4px 5px;
        border-bottom: 1px solid #e5e7eb;
      }
      .catalog-table input {
        width: 100%;
        padding: 3px 4px;
        font-size: 11px;
      }
    </style>
  </head>
  <body>
    <div class="app">
      <header>
        <div>
          <h1>BLANCO Clothing</h1>
          <span id="viewLabel">Dashboard</span>
        </div>
        <span id="lastActivity">No orders yet</span>
      </header>

      <div class="nav">
        <button id="nav-dashboard" class="active">Dashboard</button>
        <button id="nav-order">+ Order</button>
        <button id="nav-orders">Orders</button>
        <button id="nav-products">Products</button>
      </div>

      <!-- DASHBOARD -->
      <div id="view-dashboard" class="view active">
        <section class="card">
          <h2>Snapshot</h2>
          <p class="subtext">
            Overview of offline activity on this device only.
          </p>
          <div class="stats-row">
            <div class="stat-card">
              <div class="stat-label">Offline orders</div>
              <div id="stat-orders" class="stat-value">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Styles in catalog</div>
              <div id="stat-styles" class="stat-value">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Last activity</div>
              <div id="stat-last" class="stat-value" style="font-size:13px">
                —
              </div>
            </div>
          </div>
          <div class="actions" style="justify-content:flex-start;margin-top:8px">
            <button id="dash-new-order">+ New order</button>
            <button id="dash-orders" class="secondary small">
              View orders
            </button>
            <button id="dash-products" class="secondary small">
              Manage products
            </button>
          </div>
        </section>
      </div>

      <!-- ORDER FLOW -->
      <div id="view-order" class="view">
        <section class="card">
          <div class="stepper">
            <span id="step-pill-1" class="step-pill active">1. Styles</span>
            <span>›</span>
            <span id="step-pill-2" class="step-pill">2. Colors</span>
            <span>›</span>
            <span id="step-pill-3" class="step-pill">3. Sizes & Qty</span>
          </div>

          <!-- customer -->
          <div class="field-row">
            <div>
              <label for="custName">Customer</label>
              <input id="custName" placeholder="Customer name" />
            </div>
            <div>
              <label for="custEmail">Email</label>
              <input id="custEmail" type="email" placeholder="email@club.com" />
            </div>
            <div>
              <label for="custPhone">Phone</label>
              <input id="custPhone" placeholder="+1 (555) 123-4567" />
            </div>
          </div>

          <!-- step 1 -->
          <div id="order-step-1">
            <h2>Select Styles</h2>
            <p class="subtext">
              Tap one or more styles to include in this order. Styles are loaded
              from the Products catalog.
            </p>
            <div class="field-full">
              <label for="styleSearch">Search styles</label>
              <input
                id="styleSearch"
                placeholder="Search by style code or name"
              />
            </div>
            <div id="stylesGrid" class="styles-grid"></div>
            <div id="stylesEmpty" class="subtext">
              No styles yet – add products first.
            </div>
            <div class="actions">
              <button id="step1-next" class="secondary">
                Continue to colors ›
              </button>
            </div>
          </div>

          <!-- step 2 -->
          <div id="order-step-2" style="display:none">
            <h2>Choose Colors</h2>
            <p class="subtext">
              For each selected style, pick one or more colors.
            </p>
            <div id="colorsContainer"></div>
            <div class="actions" style="justify-content:space-between">
              <button id="step2-back" class="secondary">
                ‹ Back to styles
              </button>
              <button id="step2-next">Continue to sizes & qty ›</button>
            </div>
          </div>

          <!-- step 3 -->
          <div id="order-step-3" style="display:none">
            <h2>Sizes & Quantities</h2>
            <p class="subtext">
              Enter quantities for each style, color and size. Leave at 0 for
              sizes you don’t need.
            </p>
            <div id="qtyContainer"></div>
            <div class="field-full">
              <label for="orderNotes">Order notes</label>
              <textarea
                id="orderNotes"
                placeholder="Ship window, fit notes, event, etc."
              ></textarea>
            </div>
            <div class="actions" style="justify-content:space-between">
              <button id="step3-back" class="secondary">
                ‹ Back to colors
              </button>
              <div style="display:flex;gap:6px">
                <button id="clearOrder" class="secondary small">Clear</button>
                <button id="saveOrder">Save order</button>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- ORDERS -->
      <div id="view-orders" class="view">
        <section class="card">
          <h2>Orders</h2>
          <p class="subtext">
            Orders are stored locally on this device. Export to CSV for Excel.
          </p>
          <div class="actions" style="justify-content:flex-start">
            <button id="exportOrders" class="secondary small">
              Export all CSV
            </button>
            <button id="clearOrders" class="danger small">Clear all</button>
          </div>
          <div id="ordersEmpty" class="empty">
            No orders yet – create one from the + Order tab.
          </div>
          <table id="ordersTable" style="display:none;margin-top:6px">
            <thead>
              <tr>
                <th>Time</th>
                <th>Customer</th>
                <th>Style</th>
                <th>Color</th>
                <th>Size</th>
                <th>Qty</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="ordersBody"></tbody>
          </table>
        </section>
      </div>

      <!-- PRODUCTS -->
      <div id="view-products" class="view">
        <section class="card">
          <h2>Products</h2>
          <p class="subtext">
            Upload or edit your product catalog. The + Order flow reads styles,
            colors and sizes from this table.
          </p>
          <div class="field-full">
            <label for="catalogFile">Upload CSV</label>
            <input id="catalogFile" type="file" accept=".csv" />
            <div class="subtext">
              Required columns:
              <code>style_code, style_name, color, size</code> (optional:
              <code>price</code>). Export from Excel as CSV.
            </div>
          </div>
          <div class="actions" style="justify-content:flex-start">
            <button id="importCatalog" class="secondary small">
              Import / replace
            </button>
            <button id="exportCatalog" class="secondary small">
              Export CSV
            </button>
            <button id="addCatalogRow" class="small">Add row</button>
            <button id="saveCatalog" class="small">Save</button>
          </div>
          <div class="subtext" id="catalogSummary">No products loaded.</div>
          <div class="subtext" id="catalogUpdated"></div>

          <div class="catalog-table-wrapper">
            <table class="catalog-table">
              <thead>
                <tr>
                  <th>Style code</th>
                  <th>Style name</th>
                  <th>Color</th>
                  <th>Size</th>
                  <th>Price</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="catalogBody"></tbody>
            </table>
          </div>
        </section>
      </div>
    </div>

    <script>
      // SIMPLE, OLDER-SAFARI-FRIENDLY JS (no arrow functions, no fancy syntax)
      var ORDERS_KEY = "blanco_orders_v1";
      var CATALOG_KEY = "blanco_catalog_v1";

      var catalog = [];
      var selectedStyles = []; // array of styleKeys
      var selectedColors = {}; // styleKey -> { color: true }
      var currentStep = 1;

      function $(id) {
        return document.getElementById(id);
      }

      // ---------- STORAGE ----------
      function getOrders() {
        try {
          var raw = localStorage.getItem(ORDERS_KEY);
          return raw ? JSON.parse(raw) : [];
        } catch (e) {
          console.log("getOrders error", e);
          return [];
        }
      }

      function saveOrdersList(list) {
        try {
          localStorage.setItem(ORDERS_KEY, JSON.stringify(list));
        } catch (e) {
          console.log("saveOrders error", e);
        }
        updateDashboard();
      }

      function getCatalog() {
        try {
          var raw = localStorage.getItem(CATALOG_KEY);
          return raw ? JSON.parse(raw) : [];
        } catch (e) {
          console.log("getCatalog error", e);
          return [];
        }
      }

      function saveCatalog(list) {
        try {
          localStorage.setItem(CATALOG_KEY, JSON.stringify(list));
        } catch (e) {
          console.log("saveCatalog error", e);
        }
      }

      // ---------- NAV ----------
      function setView(viewId) {
        var views = [
          "view-dashboard",
          "view-order",
          "view-orders",
          "view-products",
        ];
        for (var i = 0; i < views.length; i++) {
          var v = $(views[i]);
          v.className =
            v.className.replace("active", "").replace(/\s+$/, "") || "";
        }
        $(viewId).className += " active";

        var navButtons = [
          "nav-dashboard",
          "nav-order",
          "nav-orders",
          "nav-products",
        ];
        for (var j = 0; j < navButtons.length; j++) {
          var b = $(navButtons[j]);
          b.className = b.className.replace("active", "");
        }
        if (viewId === "view-dashboard") $("nav-dashboard").className +=
          " active";
        if (viewId === "view-order") $("nav-order").className += " active";
        if (viewId === "view-orders") $("nav-orders").className += " active";
        if (viewId === "view-products") $("nav-products").className +=
          " active";

        if (viewId === "view-dashboard") $("viewLabel").innerHTML =
          "Dashboard";
        if (viewId === "view-order") $("viewLabel").innerHTML = "+ Order";
        if (viewId === "view-orders") $("viewLabel").innerHTML = "Orders";
        if (viewId === "view-products") $("viewLabel").innerHTML = "Products";

        if (viewId === "view-orders") renderOrders();
        if (viewId === "view-products") renderCatalog();
        if (viewId === "view-order") resetOrderFlow();
      }

      $("nav-dashboard").onclick = function () {
        setView("view-dashboard");
      };
      $("nav-order").onclick = function () {
        setView("view-order");
      };
      $("nav-orders").onclick = function () {
        setView("view-orders");
      };
      $("nav-products").onclick = function () {
        setView("view-products");
      };
      $("dash-new-order").onclick = function () {
        setView("view-order");
      };
      $("dash-orders").onclick = function () {
        setView("view-orders");
      };
      $("dash-products").onclick = function () {
        setView("view-products");
      };

      // ---------- DASHBOARD ----------
      function updateDashboard() {
        var orders = getOrders();
        $("stat-orders").innerHTML = String(orders.length);

        var styleMap = {};
        for (var i = 0; i < catalog.length; i++) {
          var code = (catalog[i].style_code || "").trim();
          if (code) styleMap[code] = true;
        }
        var styleCount = 0;
        for (var k in styleMap) {
          if (styleMap.hasOwnProperty(k)) styleCount++;
        }
        $("stat-styles").innerHTML = String(styleCount);

        if (!orders.length) {
          $("stat-last").innerHTML = "—";
          $("lastActivity").innerHTML = "No orders yet";
        } else {
          var last = orders[orders.length - 1];
          var ts = new Date(last.created_at).toLocaleString();
          $("stat-last").innerHTML = ts;
          $("lastActivity").innerHTML = "Last order: " + ts;
        }
      }

      // ---------- CATALOG STRUCTURE ----------
      function getStyleKey(row) {
        var code = (row.style_code || "").trim();
        var name = (row.style_name || "").trim();
        return code || name;
      }

      function buildStylesIndex() {
        var map = {}; // styleKey -> {name, code, price, colors:{ color: {sizes:[]}}}
        for (var i = 0; i < catalog.length; i++) {
          var row = catalog[i];
          var key = getStyleKey(row);
          if (!key) continue;
          if (!map[key]) {
            map[key] = {
              key: key,
              code: (row.style_code || "").trim(),
              name: (row.style_name || "").trim(),
              price: row.price || "",
              colors: {},
            };
          }
          var color = (row.color || "").trim();
          var size = (row.size || "").trim();
          if (color) {
            if (!map[key].colors[color]) {
              map[key].colors[color] = { sizes: [] };
            }
            if (size && map[key].colors[color].sizes.indexOf(size) === -1) {
              map[key].colors[color].sizes.push(size);
            }
          }
          if (row.price && !map[key].price) map[key].price = row.price;
        }
        return map;
      }

      // ---------- ORDER FLOW ----------
      function setStep(n) {
        currentStep = n;
        $("order-step-1").style.display = n === 1 ? "block" : "none";
        $("order-step-2").style.display = n === 2 ? "block" : "none";
        $("order-step-3").style.display = n === 3 ? "block" : "none";

        $("step-pill-1").className =
          "step-pill" + (n === 1 ? " active" : "");
        $("step-pill-2").className =
          "step-pill" + (n === 2 ? " active" : "");
        $("step-pill-3").className =
          "step-pill" + (n === 3 ? " active" : "");
      }

      function resetOrderFlow() {
        setStep(1);
        $("custName").value = "";
        $("custEmail").value = "";
        $("custPhone").value = "";
        $("orderNotes").value = "";
        $("styleSearch").value = "";
        selectedStyles = [];
        selectedColors = {};
        renderStylesGrid();
        $("colorsContainer").innerHTML = "";
        $("qtyContainer").innerHTML = "";
      }

      function renderStylesGrid() {
        var stylesMap = buildStylesIndex();
        var grid = $("stylesGrid");
        var empty = $("stylesEmpty");
        grid.innerHTML = "";

        var search = $("styleSearch").value.toLowerCase();
        var any = false;

        for (var key in stylesMap) {
          if (!stylesMap.hasOwnProperty(key)) continue;
          var meta = stylesMap[key];
          var label =
            (meta.code || "") + " " + (meta.name || "");
          if (search && label.toLowerCase().indexOf(search) === -1) {
            continue;
          }
          any = true;

          var card = document.createElement("div");
          card.className = "style-card";
          card.setAttribute("data-style-key", key);
          if (selectedStyles.indexOf(key) !== -1)
            card.className += " selected";

          var nameDiv = document.createElement("div");
          nameDiv.className = "style-name";
          nameDiv.innerHTML = meta.name || meta.code || "Unnamed";

          var codeDiv = document.createElement("div");
          codeDiv.className = "style-code";
          codeDiv.innerHTML = meta.code || meta.name || "";

          var metaDiv = document.createElement("div");
          metaDiv.className = "style-meta";
          var colorCount = 0;
          var sizeCount = 0;
          for (var c in meta.colors) {
            if (!meta.colors.hasOwnProperty(c)) continue;
            colorCount++;
            sizeCount += meta.colors[c].sizes.length;
          }
          metaDiv.innerHTML =
            colorCount +
            " colors • " +
            sizeCount +
            " sizes" +
            (meta.price ? " • $" + meta.price + "/pc" : "");

          card.appendChild(nameDiv);
          card.appendChild(codeDiv);
          card.appendChild(metaDiv);

          card.onclick = function () {
            var skey = this.getAttribute("data-style-key");
            var idx = selectedStyles.indexOf(skey);
            if (idx === -1) selectedStyles.push(skey);
            else selectedStyles.splice(idx, 1);
            renderStylesGrid();
          };

          grid.appendChild(card);
        }

        empty.style.display = any ? "none" : "block";
      }

      $("styleSearch").oninput = renderStylesGrid;

      $("step1-next").onclick = function () {
        if (!selectedStyles.length) {
          alert("Select at least one style.");
          return;
        }
        renderColorSelection();
        setStep(2);
      };
      $("step2-back").onclick = function () {
        setStep(1);
      };
      $("step2-next").onclick = function () {
        var any = false;
        for (var s in selectedColors) {
          if (!selectedColors.hasOwnProperty(s)) continue;
          var colors = selectedColors[s];
          for (var c in colors) {
            if (colors.hasOwnProperty(c) && colors[c]) {
              any = true;
              break;
            }
          }
        }
        if (!any) {
          alert("Select at least one color.");
          return;
        }
        renderQtySelection();
        setStep(3);
      };
      $("step3-back").onclick = function () {
        setStep(2);
      };
      $("clearOrder").onclick = function () {
        resetOrderFlow();
      };

      function renderColorSelection() {
        var stylesMap = buildStylesIndex();
        var container = $("colorsContainer");
        container.innerHTML = "";

        for (var i = 0; i < selectedStyles.length; i++) {
          var key = selectedStyles[i];
          var meta = stylesMap[key];
          if (!meta) continue;

          if (!selectedColors[key]) selectedColors[key] = {};

          var card = document.createElement("div");
          card.className = "color-card";

          var header = document.createElement("div");
          header.className = "color-header";
          header.innerHTML =
            "<strong>" +
            (meta.name || meta.code || "Style") +
            "</strong><br/><span style='font-size:11px;color:#6b7280'>" +
            (meta.code || "") +
            "</span>";
          card.appendChild(header);

          var body = document.createElement("div");
          body.className = "color-body";

          var label = document.createElement("label");
          label.innerHTML = "Choose colors";
          body.appendChild(label);

          var list = document.createElement("div");
          list.className = "color-list";

          for (var color in meta.colors) {
            if (!meta.colors.hasOwnProperty(color)) continue;

            var chip = document.createElement("div");
            chip.className = "color-chip";
            chip.setAttribute("data-style-key", key);
            chip.setAttribute("data-color", color);
            if (selectedColors[key][color]) {
              chip.className += " selected";
            }
            chip.innerHTML = color;

            chip.onclick = function () {
              var sk = this.getAttribute("data-style-key");
              var col = this.getAttribute("data-color");
              if (!selectedColors[sk]) selectedColors[sk] = {};
              selectedColors[sk][col] = !selectedColors[sk][col];
              renderColorSelection();
            };

            list.appendChild(chip);
          }

          body.appendChild(list);
          card.appendChild(body);
          container.appendChild(card);
        }

        if (!selectedStyles.length) {
          container.innerHTML =
            "<div class='subtext'>No styles selected.</div>";
        }
      }

      function renderQtySelection() {
        var stylesMap = buildStylesIndex();
        var container = $("qtyContainer");
        container.innerHTML = "";

        for (var i = 0; i < selectedStyles.length; i++) {
          var key = selectedStyles[i];
          var meta = stylesMap[key];
          if (!meta) continue;
          var colorsMap = selectedColors[key] || {};

          for (var color in colorsMap) {
            if (
              !colorsMap.hasOwnProperty(color) ||
              !colorsMap[color]
            )
              continue;

            var sizesInfo = meta.colors[color];
            if (!sizesInfo) continue;

            var card = document.createElement("div");
            card.className = "qty-card";

            var header = document.createElement("div");
            header.className = "qty-header";
            header.innerHTML =
              "<span>" +
              (meta.name || meta.code) +
              " • " +
              color +
              "</span><span>" +
              (meta.price ? "$" + meta.price + "/pc" : "") +
              "</span>";
            card.appendChild(header);

            var grid = document.createElement("div");
            grid.className = "sizes-grid";

            var sizes = sizesInfo.sizes.slice();
            sizes.sort(function (a, b) {
              return a.localeCompare(b, undefined, { numeric: true });
            });

            for (var s = 0; s < sizes.length; s++) {
              var size = sizes[s];
              var chip = document.createElement("div");
              chip.className = "size-chip";

              var lab = document.createElement("label");
              lab.innerHTML = size;
              chip.appendChild(lab);

              var input = document.createElement("input");
              input.type = "number";
              input.min = "0";
              input.step = "1";
              input.value = "";
              input.setAttribute("data-style-key", key);
              input.setAttribute("data-color", color);
              input.setAttribute("data-size", size);
              chip.appendChild(input);

              grid.appendChild(chip);
            }

            card.appendChild(grid);
            container.appendChild(card);
          }
        }

        if (!container.innerHTML) {
          container.innerHTML =
            "<div class='subtext'>No colors selected.</div>";
        }
      }

      $("saveOrder").onclick = function () {
        var cust = $("custName").value.replace(/\s+$/, "");
        if (!cust) {
          alert("Customer name is required.");
          return;
        }
        var email = $("custEmail").value;
        var phone = $("custPhone").value;
        var notes = $("orderNotes").value;

        var inputs = $("qtyContainer").getElementsByTagName("input");
        var lines = [];
        for (var i = 0; i < inputs.length; i++) {
          var el = inputs[i];
          if (!el.getAttribute("data-size")) continue;
          var qty = Number(el.value || 0);
          if (qty <= 0) continue;
          lines.push({
            styleKey: el.getAttribute("data-style-key"),
            color: el.getAttribute("data-color"),
            size: el.getAttribute("data-size"),
            qty: qty,
          });
        }
        if (!lines.length) {
          alert("Enter quantity for at least one size.");
          return;
        }

        var stylesMap = buildStylesIndex();
        var nowIso = new Date().toISOString();
        var orders = getOrders();

        for (var j = 0; j < lines.length; j++) {
          var ln = lines[j];
          var meta = stylesMap[ln.styleKey] || {};
          orders.push({
            created_at: nowIso,
            customer_name: cust,
            customer_email: email,
            customer_phone: phone,
            style_code: meta.code || "",
            style_name: meta.name || "",
            color: ln.color,
            size: ln.size,
            qty: ln.qty,
            notes: notes,
          });
        }

        saveOrdersList(orders);
        renderOrders();
        resetOrderFlow();
        alert("Order saved on this device.");
      };

      // ---------- ORDERS VIEW ----------
      function renderOrders() {
        var orders = getOrders();
        var table = $("ordersTable");
        var body = $("ordersBody");
        var empty = $("ordersEmpty");
        body.innerHTML = "";

        if (!orders.length) {
          table.style.display = "none";
          empty.style.display = "block";
          return;
        }
        table.style.display = "table";
        empty.style.display = "none";

        for (var i = 0; i < orders.length; i++) {
          var o = orders[i];
          var tr = document.createElement("tr");
          var time = new Date(o.created_at).toLocaleTimeString([], {
            hour: "2-digit",
            minute: "2-digit",
          });

          tr.innerHTML =
            "<td>" +
            time +
            "</td><td>" +
            (o.customer_name || "") +
            "</td><td>" +
            (o.style_name || o.style_code || "") +
            "</td><td>" +
            (o.color || "") +
            "</td><td>" +
            (o.size || "") +
            "</td><td>" +
            (o.qty || "") +
            "</td><td><button class='secondary small' data-idx='" +
            i +
            "'>Export</button></td>";

          body.appendChild(tr);
        }
      }

      $("ordersBody").onclick = function (e) {
        var t = e.target || e.srcElement;
        if (!t || t.tagName.toLowerCase() !== "button") return;
        var idx = t.getAttribute("data-idx");
        if (idx == null) return;
        var orders = getOrders();
        var o = orders[Number(idx)];
        if (!o) return;
        downloadCSV([o], "blanco_order_" + (o.customer_name || "") + ".csv");
      };

      $("exportOrders").onclick = function () {
        var orders = getOrders();
        if (!orders.length) {
          alert("No orders to export.");
          return;
        }
        downloadCSV(
          orders,
          "blanco_orders_" + new Date().toISOString().slice(0, 10) + ".csv"
        );
      };

      $("clearOrders").onclick = function () {
        if (!confirm("Delete all orders on this device?")) return;
        saveOrdersList([]);
        renderOrders();
      };

      function downloadCSV(orders, filename) {
        var headers = [
          "created_at",
          "customer_name",
          "customer_email",
          "customer_phone",
          "style_code",
          "style_name",
          "color",
          "size",
          "qty",
          "notes",
        ];
        var rows = [headers];

        for (var i = 0; i < orders.length; i++) {
          var o = orders[i];
          rows.push([
            o.created_at || "",
            o.customer_name || "",
            o.customer_email || "",
            o.customer_phone || "",
            o.style_code || "",
            o.style_name || "",
            o.color || "",
            o.size || "",
            o.qty || "",
            (o.notes || "").replace(/\n/g, " "),
          ]);
        }

        var lines = [];
        for (var r = 0; r < rows.length; r++) {
          var row = rows[r];
          for (var c = 0; c < row.length; c++) {
            row[c] =
              '"' + String(row[c]).replace(/"/g, '""') + '"';
          }
          lines.push(row.join(","));
        }
        var csv = lines.join("\n");
        var blob = new Blob([csv], {
          type: "text/csv;charset=utf-8;",
        });
        var url = URL.createObjectURL(blob);
        var a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // ---------- CATALOG VIEW ----------
      var catalogBody = $("catalogBody");

      function renderCatalog() {
        catalogBody.innerHTML = "";
        for (var i = 0; i < catalog.length; i++) {
          var row = catalog[i];
          var tr = document.createElement("tr");
          tr.innerHTML =
            "<td><input data-i='" +
            i +
            "' data-f='style_code' value='" +
            (row.style_code || "").replace(/"/g, "&quot;") +
            "'></td>" +
            "<td><input data-i='" +
            i +
            "' data-f='style_name' value='" +
            (row.style_name || "").replace(/"/g, "&quot;") +
            "'></td>" +
            "<td><input data-i='" +
            i +
            "' data-f='color' value='" +
            (row.color || "").replace(/"/g, "&quot;") +
            "'></td>" +
            "<td><input data-i='" +
            i +
            "' data-f='size' value='" +
            (row.size || "").replace(/"/g, "&quot;") +
            "'></td>" +
            "<td><input data-i='" +
            i +
            "' data-f='price' value='" +
            (row.price || "").replace(/"/g, "&quot;") +
            "'></td>" +
            "<td><button class='secondary small' data-dup='" +
            i +
            "'>Dup</button> <button class='danger small' data-del='" +
            i +
            "'>X</button></td>";
          catalogBody.appendChild(tr);
        }

        var styleCountMap = {};
        for (var k = 0; k < catalog.length; k++) {
          var code = (catalog[k].style_code || "").trim();
          if (code) styleCountMap[code] = true;
        }
        var styleCount = 0;
        for (var key in styleCountMap) {
          if (styleCountMap.hasOwnProperty(key)) styleCount++;
        }

        $("catalogSummary").innerHTML =
          catalog.length + " rows • " + styleCount + " styles";
      }

      catalogBody.oninput = function (e) {
        var t = e.target || e.srcElement;
        if (t.tagName.toLowerCase() !== "input") return;
        var i = Number(t.getAttribute("data-i"));
        var f = t.getAttribute("data-f");
        catalog[i][f] = t.value;
        saveCatalog(catalog);
        updateDashboard();
      };

      catalogBody.onclick = function (e) {
        var t = e.target || e.srcElement;
        if (t.tagName.toLowerCase() !== "button") return;
        var del = t.getAttribute("data-del");
        var dup = t.getAttribute("data-dup");
        if (del != null) {
          catalog.splice(Number(del), 1);
          saveCatalog(catalog);
          renderCatalog();
          updateDashboard();
        } else if (dup != null) {
          var row = catalog[Number(dup)];
          catalog.splice(Number(dup) + 1, 0, {
            style_code: row.style_code,
            style_name: row.style_name,
            color: row.color,
            size: row.size,
            price: row.price,
          });
          saveCatalog(catalog);
          renderCatalog();
          updateDashboard();
        }
      };

      $("addCatalogRow").onclick = function () {
        catalog.push({
          style_code: "",
          style_name: "",
          color: "",
          size: "",
          price: "",
        });
        saveCatalog(catalog);
        renderCatalog();
        updateDashboard();
      };

      $("saveCatalog").onclick = function () {
        saveCatalog(catalog);
        $("catalogUpdated").innerHTML =
          "Saved " + new Date().toLocaleString();
        updateDashboard();
      };

      $("importCatalog").onclick = function () {
        var fileInput = $("catalogFile");
        var file =
          fileInput && fileInput.files && fileInput.files[0];
        if (!file) {
          alert("Choose a CSV file first.");
          return;
        }
        var reader = new FileReader();
        reader.onload = function (e) {
          var text = e.target.result;
          var rows = parseCsv(text);
          if (!rows.length) {
            alert("No rows in CSV.");
            return;
          }
          var first = rows[0];
          var req = [
            "style_code",
            "style_name",
            "color",
            "size",
          ];
          var missing = [];
          for (var i = 0; i < req.length; i++) {
            if (!first.hasOwnProperty(req[i])) missing.push(req[i]);
          }
          if (missing.length) {
            alert(
              "Missing columns: " +
                missing.join(", ") +
                ". CSV must have style_code, style_name, color, size."
            );
            return;
          }
          catalog = [];
          for (var j = 0; j < rows.length; j++) {
            catalog.push({
              style_code: rows[j].style_code || "",
              style_name: rows[j].style_name || "",
              color: rows[j].color || "",
              size: rows[j].size || "",
              price: rows[j].price || "",
            });
          }
          saveCatalog(catalog);
          renderCatalog();
          updateDashboard();
          alert("Catalog imported.");
        };
        reader.readAsText(file);
      };

      $("exportCatalog").onclick = function () {
        if (!catalog.length) {
          alert("No catalog to export.");
          return;
        }
        var headers = [
          "style_code",
          "style_name",
          "color",
          "size",
          "price",
        ];
        var rows = [headers];
        for (var i = 0; i < catalog.length; i++) {
          var r = catalog[i];
          rows.push([
            r.style_code || "",
            r.style_name || "",
            r.color || "",
            r.size || "",
            r.price || "",
          ]);
        }
        var lines = [];
        for (var rowIdx = 0; rowIdx < rows.length; rowIdx++) {
          var row = rows[rowIdx];
          for (var c = 0; c < row.length; c++) {
            row[c] =
              '"' + String(row[c]).replace(/"/g, '""') + '"';
          }
          lines.push(row.join(","));
        }
        var csv = lines.join("\n");
        var blob = new Blob([csv], {
          type: "text/csv;charset=utf-8;",
        });
        var url = URL.createObjectURL(blob);
        var a = document.createElement("a");
        a.href = url;
        a.download =
          "blanco_catalog_" +
          new Date().toISOString().slice(0, 10) +
          ".csv";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };

      function parseCsv(text) {
        var lines = text.split(/\r?\n/);
        var out = [];
        if (!lines.length) return out;
        var header = lines[0].split(",");
        for (var i = 0; i < header.length; i++) {
          header[i] = header[i].trim().toLowerCase();
        }
        for (var r = 1; r < lines.length; r++) {
          var line = lines[r];
          if (!line) continue;
          var cols = line.split(",");
          var obj = {};
          for (var c = 0; c < header.length; c++) {
            obj[header[c]] = (cols[c] || "").replace(/^"|"$/g, "");
          }
          out.push(obj);
        }
        return out;
      }

      // ---------- INIT ----------
      (function init() {
        catalog = getCatalog();
        renderCatalog();
        renderStylesGrid();
        updateDashboard();
        renderOrders();
      })();
    </script>
  </body>
</html>
